permissions:
  contents: write
  actions: read

name: éƒ¨ç½² VitePress éœæ…‹ç¶²ç«™åˆ° GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  full-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: é·å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: éƒ¨å±¬æ—¥èªŒ
        run: |
          deleted_any=0
          for en_file in en/blog/*.md; do
            [ ! -f "$en_file" ] && continue
            base_file="blog/$(basename "$en_file")"
            if [ ! -f "$base_file" ]; then
              git rm "$en_file"
              echo "Deleted $en_file (orphan)"
              deleted_any=1
            fi
          done
          if [ $deleted_any -eq 1 ]; then
            git config --global user.name 'System Administrator'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git commit -am "chore: sync delete en/blog files"
            git pull --rebase origin main
            git push || git push --force
          else
            echo "No en/blog files to delete."
          fi

      - name: è¨­å®š Node.js èˆ‡å¿«å–
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'

      - name: å®‰è£ç›¸ä¾å¥—ä»¶
        run: yarn install

      - name: ç”¢ç”Ÿä½œè€…æ¸…å–®
        run: node .vitepress/components/generateAuthors.cjs

      - name: ç”¢ç”Ÿå´é‚Šæ¬„
        run: node .vitepress/components/generateSidebar.cjs

      - name: amend sidebar é€²æœ€æ–° commitï¼ˆå¦‚æœ‰è®Šæ›´ï¼‰
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git add .vitepress/sidebar.generated.ts .vitepress/sidebar.generated.en.ts .vitepress/theme/authors.json
          if git diff --cached --quiet; then
            echo "æ²’æœ‰ sidebar æˆ– authors è®Šæ›´ï¼Œç„¡éœ€ amend"
          else
            git commit --amend --no-edit
            git push --force-with-lease
            echo "å·² amend sidebar / authors é€²åŸæœ¬ commit"
          fi

      - name: Commit ä¸¦ push yarn.lock
        run: |
          git config --global user.name 'System Administrator'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          if git diff --quiet yarn.lock; then
            echo "No changes to yarn.lock."
          else
            git add yarn.lock
            git commit -m "chore: update yarn.lock [bot]"
            git pull --rebase origin main
            git push || git push --force
          fi

      - name: å‚™ä»½ã€ç”¢ç”Ÿã€é‚„åŸä¸¦éäº¤è‹±æ–‡ Blog æª”æ¡ˆ
        shell: /usr/bin/bash -e {0}
        run: |
          # --- éšæ®µ 1: å‚™ä»½æ‰€æœ‰å·²å­˜åœ¨çš„è‹±æ–‡æª”æ¡ˆ ---
          BACKUP_DIR="tmp_existing_en_files"
          mkdir -p "$BACKUP_DIR"
          echo "=> éšæ®µ 1: å‚™ä»½æ‰€æœ‰å·²å­˜åœ¨çš„è‹±æ–‡æ–‡ç« ..."

          # æª¢æŸ¥ en/blog ç›®éŒ„æ˜¯å¦å­˜åœ¨ä¸”æœ‰æª”æ¡ˆ
          if [ -d "en/blog" ] && [ -n "$(ls -A en/blog/*.md 2>/dev/null)" ]; then
            echo "    - ç™¼ç¾å·²å­˜åœ¨çš„æª”æ¡ˆï¼Œæ­£åœ¨ç§»è‡³æš«å­˜å€ä»¥é¿å…è¢«è¦†è“‹..."
            mv en/blog/*.md "$BACKUP_DIR/"
          else
            echo "    - en/blog/ ç›®éŒ„ç‚ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œç„¡éœ€å‚™ä»½ã€‚"
          fi

          # --- éšæ®µ 2: ç”¢ç”Ÿéè£œæª”æ¡ˆ ---
          echo "=> éšæ®µ 2: åŸ·è¡Œéè£œæª”æ¡ˆç”¢ç”Ÿç¨‹åº (yarn gen-en-blog)..."
          yarn gen-en-blog
          echo "    - ç”¢ç”Ÿç¨‹åºå®Œæˆã€‚"

          # --- éšæ®µ 3: é‚„åŸå‚™ä»½çš„æª”æ¡ˆ ---
          echo "=> éšæ®µ 3: é‚„åŸå…ˆå‰å·²å­˜åœ¨çš„è‹±æ–‡æª”æ¡ˆ..."
          if [ -n "$(ls -A $BACKUP_DIR 2>/dev/null)" ]; then
            mv -f "$BACKUP_DIR"/* en/blog/
            echo "    - å·²é‚„åŸå‚™ä»½çš„æª”æ¡ˆã€‚"
          else
            echo "    - æ²’æœ‰éœ€è¦é‚„åŸçš„æª”æ¡ˆã€‚"
          fi
          rm -rf "$BACKUP_DIR"

          # --- éšæ®µ 4: Commit ä¸¦ Push è®Šæ›´ ---
          echo "=> éšæ®µ 4: æª¢æŸ¥æ˜¯å¦æœ‰æ–°æª”æ¡ˆéœ€è¦æäº¤..."
          git config --global user.name 'System Administrator'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add en/blog/

          if git diff --cached --quiet; then
            echo "    - æ²’æœ‰æ–°ç”¢ç”Ÿçš„éè£œæª”æ¡ˆéœ€è¦æäº¤ã€‚"
          else
            echo "    - åµæ¸¬åˆ°æ–°ç”¢ç”Ÿçš„éè£œæª”æ¡ˆï¼Œæ­£åœ¨æäº¤..."
            git commit -m "chore: auto-generate en blog placeholders"
            git pull --rebase origin main
            git push --set-upstream origin main || git push
            echo "    - æ–°æª”æ¡ˆå·²æˆåŠŸæäº¤ã€‚"
          fi

      - name: æ¸…é™¤ Vite/VitePress å¿«å–
        run: |
          rm -rf .vitepress/.cache .vitepress/dist .vite node_modules/.vite

      - name: å»ºç½® VitePress ç¶²ç«™
        run: yarn run build

      - name: é‚„åŸ git user è¨­å®š
        run: |
          git config --global --unset user.name || true
          git config --global --unset user.email || true

      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: gh-pages
          folder: .vitepress/dist
          clean: true

      - name: åµæ¸¬æ–°æ–‡ç« 
        id: detect-new-files
        run: |
          TARGET_DIR="blog/"
          CURRENT_SHA="${{ github.sha }}"

          is_null_sha() {
            [ -z "$1" ] || [[ "$1" =~ ^0{40}$ ]]
          }

          if [ -n "${{ github.event.before }}" ] && git cat-file -e "${{ github.event.before }}" 2>/dev/null; then
            LAST_COMMIT_SHA="${{ github.event.before }}"
          elif git cat-file -e "${CURRENT_SHA}~1" 2>/dev/null; then
            LAST_COMMIT_SHA="$(git rev-parse "${CURRENT_SHA}~1")"
          else
            LAST_COMMIT_SHA=""
          fi

          OUTPUT_FILE="new_post_files.txt"
          DETECTED_FILES=""

          if is_null_sha "$LAST_COMMIT_SHA"; then
            DETECTED_FILES=$(git diff --name-only --diff-filter=A "${CURRENT_SHA}" -- "$TARGET_DIR")
          else
            DETECTED_FILES=$(git diff --name-only --diff-filter=A "${LAST_COMMIT_SHA}" "${CURRENT_SHA}" -- "$TARGET_DIR")
          fi

          echo "$DETECTED_FILES" | grep . > "$OUTPUT_FILE" || true
          if [ -s "$OUTPUT_FILE" ]; then
            echo "åµæ¸¬åˆ°æ–°æ–‡ç« ï¼Œåˆ—è¡¨å·²å„²å­˜è‡³ $OUTPUT_FILE"
            echo "has_new_files=true" >> $GITHUB_ENV
          else
            echo "æ²’æœ‰åµæ¸¬åˆ°æ–°æ–‡ç« "
            echo "has_new_files=false" >> $GITHUB_ENV
          fi

      - name: è™•ç†ä¸¦ç™¼é€ Telegram é€šçŸ¥
        if: env.has_new_files == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          ORIGINAL_COMMIT: ${{ github.sha }}
        run: |
            set -e
            NEW_POST_FILES=$(cat new_post_files.txt)
            if [ -z "$NEW_POST_FILES" ]; then
            echo "æ–‡ç« åˆ—è¡¨ç‚ºç©ºï¼Œä¸­æ­¢åŸ·è¡Œã€‚"
            exit 0
            fi
            BASE_URL="https://holybear.me"
            escape_markdownv2() {
            printf "%s" "$1" | sed -e 's/[\\_*\[\]()~`>#+\-=|{}.!]/\\&/g'
            }

            for file_path in $NEW_POST_FILES; do
            echo "Processing file: $file_path"
    
            file_content=$(cat "$file_path")
            TITLE=$(echo "$file_content" | awk -F': ' '/^title:/ {print $2; exit}')
            if [ -z "$TITLE" ]; then
            TITLE=$(echo "$file_content" | awk -F'# ' '/^# / {print $2; exit}')
            fi
            [ -z "$TITLE" ] && TITLE="ç„¡æ¨™é¡Œæ–‡ç« "
            CATEGORY=""
            CATEGORY=$(echo "$file_content" | grep -A 1 -iE '^\s*category:' | grep -E '^\s*-\s*' | head -n1 | sed -E 's/^\s*-\s*(.*)/\1/')
            [ -z "$CATEGORY" ] && CATEGORY=$(echo "$file_content" | grep -iE '^\s*category:\s*\[.*\]' | sed -E 's/.*\[\s*([^, ]*).*/\1/')
            [ -z "$CATEGORY" ] && CATEGORY=$(echo "$file_content" | grep -iE '^\s*category:\s*[^-\[]+' | head -n1 | sed -E 's/^\s*category:\s*//')
            CATEGORY=$(echo "$CATEGORY" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g' | sed -E 's/[\x27"\/]//g')
            if [ -n "$CATEGORY" ]; then
            TITLE="ã€${CATEGORY}ã€‘${TITLE}"
            fi
            ARTICLE_SLUG=$(echo "$file_path" | sed -E 's|^blog/(.*)\.md$|\1|')
            ARTICLE_URL="${BASE_URL}/blog/${ARTICLE_SLUG}"
    
            # âœ¨ START: æ–°å¢çš„ç­‰å¾…æª¢æŸ¥é‚è¼¯ âœ¨
            echo "ç­‰å¾…æ—¥èªŒç¶²å€ç”Ÿæ•ˆï¼š${ARTICLE_URL}"
            timeout=180 # æœ€é•·ç­‰å¾… 180 ç§’ (3 åˆ†é˜)
            interval=20 # æ¯ 20 ç§’æª¢æŸ¥ä¸€æ¬¡
            elapsed=0
            while [ $elapsed -lt $timeout ]; do
            # ä½¿ç”¨ curl æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
            response_code=$(curl -s -o /dev/null -w "%{http_code}" "${ARTICLE_URL}")
            if [ "$response_code" -eq 200 ]; then
              echo "âœ… æ—¥èªŒå·²ä¸Šç·šï¼"
            break
            fi
              echo "æ—¥èªŒç¶²å€å°šæœªç”Ÿæ•ˆ (HTTP ${response_code})ï¼Œç­‰å¾… ${interval} ç§’â€¦"
            sleep $interval
            elapsed=$((elapsed + interval))
            done

            # å¦‚æœè¶…æ™‚å¾Œç¶²å€ä»ç„¶ç„¡æ³•è¨ªå•ï¼Œå‰‡è·³éæ­¤æª”æ¡ˆçš„é€šçŸ¥
            if [ $elapsed -ge $timeout ]; then
              echo "âŒ ç­‰å¾…æ—¥èªŒç¶²å€ç”Ÿæ•ˆå·²é€¾æ™‚ï¼Œè·³éä»¥ä¸‹é€šçŸ¥ï¼š$file_path"
            continue # ç¹¼çºŒè™•ç†ä¸‹ä¸€å€‹æª”æ¡ˆ
            fi
            # âœ¨ END: æ–°å¢çš„ç­‰å¾…æª¢æŸ¥é‚è¼¯ âœ¨

            COMMIT_MESSAGE=$(git log -1 --pretty=%B "$ORIGINAL_COMMIT")
            AUTHOR_NAME=$(git log -1 --pretty=%an "$ORIGINAL_COMMIT")
            ESCAPED_TITLE=$(escape_markdownv2 "$TITLE")
            ESCAPED_COMMIT_MESSAGE=$(escape_markdownv2 "$COMMIT_MESSAGE")
            ESCAPED_AUTHOR_NAME=$(escape_markdownv2 "$AUTHOR_NAME")
    
            MESSAGE=$'*ğŸ“¢ New push to GitHub*\n'
            MESSAGE+=$'*'"${ESCAPED_TITLE}"$'*\n'
            MESSAGE+=$'```commit\n'"${ESCAPED_COMMIT_MESSAGE}"$'\n```'
            MESSAGE+=$'â¡ï¸ [é»æ­¤é–±è®€æ–‡ç« ]('"${ARTICLE_URL}"$')\n'
            MESSAGE+='by `'"${ESCAPED_AUTHOR_NAME}"'`'
    
            RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${MESSAGE}" \
            --data-urlencode "parse_mode=MarkdownV2" \
            --data-urlencode "disable_web_page_preview=false") # ç¢ºä¿é€™è£¡è¨­ç‚º false
      
            if echo "$RESPONSE" | grep -q '"ok":true'; then
              echo "âœ… Telegram é€šçŸ¥å·²æˆåŠŸç™¼é€ï¼š$file_path"
            else
              echo "âŒ ç„¡æ³•ç™¼é€ Telegram é€šçŸ¥ï¼š$file_path"
              echo "Telegram API å›æ‡‰ï¼š$RESPONSE"
            fi
            done
