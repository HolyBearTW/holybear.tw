name: Notify New Blog Post to Telegram # å·¥ä½œæµç¨‹åç¨±

# ç•¶æœ‰æ–°çš„ push äº‹ä»¶ç™¼ç”Ÿæ™‚è§¸ç™¼æ­¤ workflow
on:
  push:
    branches:
      - main # ç›£æ§ main åˆ†æ”¯
    paths:
      - 'blog/**' # ç›£æ§ 'blog/' ç›®éŒ„ä¸‹çš„ä»»ä½•æª”æ¡ˆè®Šå‹•

jobs:
  notify_new_post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ç²å–æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Œä»¥ä¾¿ git diff èƒ½æ­£ç¢ºåˆ¤æ–·

      - name: Get new files in target directory
        id: get-new-files
        run: |
          TARGET_DIR="blog/"
          # ä½¿ç”¨ git diff å®‰å…¨åœ°æ‰¾å‡ºæ‰€æœ‰æœ¬æ¬¡ commit æ–°å¢çš„ .md æª”æ¡ˆ (A=Added)
          # --name-only åªè¼¸å‡ºæª”å
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- "$TARGET_DIR" | grep '\.md$')
          
          # å°‡æ‰¾åˆ°çš„æª”æ¡ˆåˆ—è¡¨ï¼ˆå¯èƒ½æœ‰å¤šè¡Œï¼‰è¨­å®šç‚º GitHub Actions çš„è¼¸å‡º
          # ä½¿ç”¨ç‰¹æ®Šçš„ EOF èªæ³•ä¾†è™•ç†å¤šè¡Œå­—ä¸²ï¼Œé€™æ˜¯å®˜æ–¹å»ºè­°çš„æœ€ç©©å¥ä½œæ³•
          echo "new_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "${NEW_FILES}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Process and send Telegram notification
        # åªæœ‰ç•¶ä¸Šä¸€æ­¥é©Ÿ 'get-new-files' æœ‰æ‰¾åˆ°æª”æ¡ˆæ™‚æ‰åŸ·è¡Œ
        if: steps.get-new-files.outputs.new_files != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          # å°‡ä¸Šä¸€æ­¥çš„è¼¸å‡ºå‚³å…¥ç’°å¢ƒè®Šæ•¸ï¼Œä»¥ä¾¿åœ¨è…³æœ¬ä¸­è®€å–
          NEW_POST_FILES: ${{ steps.get-new-files.outputs.new_files }}
        run: |
          # ã€é‡è¦è¨­å®šã€‘æ‚¨çš„ç¶²ç«™åŸºç¤ç¶²å€
          BASE_URL="https://holybear.me"

          # å‡½å¼ï¼šå°å­—ä¸²é€²è¡Œ MarkdownV2 ç‰¹æ®Šå­—å…ƒè·³è„«
          # è™•ç†å®˜æ–¹åˆ—è¡¨ä¸­çš„æ‰€æœ‰ä¿ç•™å­—å…ƒ: _ * [ ] ( ) ~ ` > # + - = | { } . !
          escape_markdownv2() {
            local text="$1"
            # ä½¿ç”¨å–®ä¸€çš„ sed å‘½ä»¤ï¼Œåœ¨æ‰€æœ‰ä¿ç•™å­—å…ƒå‰åŠ ä¸Šä¸€å€‹åæ–œç·š `\`
            echo "$text" | sed 's/\([_*\[\]()~`>#+\-=|{}.!]\)/\\\1/g'
          }

          # ä½¿ç”¨ while read è¿´åœˆå®‰å…¨åœ°è™•ç†æ¯ä¸€å€‹æª”æ¡ˆè·¯å¾‘ï¼Œå³ä½¿æª”ååŒ…å«ç©ºæ ¼
          echo "${NEW_POST_FILES}" | while IFS= read -r file_path; do
            if [ -z "$file_path" ]; then
              continue
            fi
            
            echo "Processing file: $file_path"

            # è®€å–æª”æ¡ˆå…§å®¹ï¼Œä¸¦ç§»é™¤å¯èƒ½å­˜åœ¨çš„ Windows æ›è¡Œç¬¦ \r
            file_content=$(tr -d '\r' < "$file_path")
            
            # å¾ Markdown æª”æ¡ˆå…§å®¹ä¸­æå– title
            TITLE=$(echo "$file_content" | awk -F': ' '/^title:/ {print $2; exit}')
            if [ -z "$TITLE" ]; then
              TITLE=$(echo "$file_content" | awk -F'# ' '/^# / {print $2; exit}')
            fi
            if [ -z "$TITLE" ]; then
              TITLE="ç„¡æ¨™é¡Œæ–‡ç« "
            fi

            # è·³è„«æ¨™é¡Œ
            ESCAPED_TITLE=$(escape_markdownv2 "$TITLE")
            
            # ç”¢ç”Ÿæ–‡ç« é€£çµ (ç¶²å€æœ¬èº«ä¸éœ€è¦è·³è„«)
            ARTICLE_SLUG=$(echo "$file_path" | sed -E 's|^blog/(.*)\.md$|\1|')
            ARTICLE_URL="${BASE_URL}/${ARTICLE_SLUG}" # è«‹ç¢ºèªæ‚¨çš„ç¶²å€çµæ§‹æ˜¯å¦éœ€è¦ .html å¾Œç¶´
            
            # å–å¾—ä¸¦è·³è„« commit ç›¸é—œè³‡è¨Š
            COMMIT_MESSAGE=$(git log -1 --pretty=%B)
            ESCAPED_COMMIT_MESSAGE=$(escape_markdownv2 "$COMMIT_MESSAGE")
            AUTHOR_NAME=$(git log -1 --pretty=%an)
            ESCAPED_AUTHOR_NAME=$(escape_markdownv2 "$AUTHOR_NAME")
            
            # ä½¿ç”¨æ‚¨åå¥½çš„ MESSAGE+= é¢¨æ ¼ä¾†çµ„è£è¨Šæ¯
            MESSAGE="*ğŸ“¢ New push to GitHub*\n\n" # GitHub æ¨æ’­é€šçŸ¥ï¼Œç²—é«”
            MESSAGE+="*${ESCAPED_TITLE}*\n\n" # æ–‡ç« æ¨™é¡Œï¼Œç²—é«”
            MESSAGE+="\`\`\`\n${ESCAPED_COMMIT_MESSAGE}\n\`\`\`\n" # æäº¤è¨Šæ¯å…§å®¹ï¼Œä½¿ç”¨ ``` å€å¡ŠåŒ…è¦†
            MESSAGE+="[â¡ï¸ é»æ­¤é–±è®€æ–‡ç« ](${ARTICLE_URL})\n\n" # æ–‡ç« é€£çµ
            MESSAGE+="by \`${ESCAPED_AUTHOR_NAME}\`" # åŠ ä¸Šä½œè€…åç¨±ï¼Œä»¥ç­‰å¯¬å­—é«”å‘ˆç¾

            # ç™¼é€ Telegram è¨Šæ¯ (ä½¿ç”¨ --data-urlencodeï¼Œæœ€å®‰å…¨å¯é )
            RESPONSE=$(curl -s -X POST "[https://api.telegram.org/bot$](https://api.telegram.org/bot$){TELEGRAM_BOT_TOKEN}/sendMessage" \
              --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
              --data-urlencode "text=${MESSAGE}" \
              --data-urlencode "parse_mode=MarkdownV2" \
              --data-urlencode "disable_web_page_preview=true")

            # æª¢æŸ¥ API å›æ‡‰ï¼Œæä¾›æ›´æ˜ç¢ºçš„æˆåŠŸæˆ–å¤±æ•—è¨Šæ¯
            if echo "$RESPONSE" | grep -q '"ok":true'; then
              echo "âœ… Telegram notification sent successfully for: $file_path"
            else
              echo "âŒ Failed to send Telegram notification for: $file_path"
              echo "Telegram API Response: $RESPONSE"
            fi

          done
