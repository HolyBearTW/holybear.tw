name: Notify New Blog Post to Telegram # å·¥ä½œæµç¨‹åç¨±

# ç•¶æœ‰æ–°çš„ push äº‹ä»¶ç™¼ç”Ÿæ™‚è§¸ç™¼æ­¤ workflow
on:
  push:
    branches:
      - main # è«‹å°‡æ­¤è™•æ”¹ç‚ºæ‚¨å„²å­˜åº«çš„ä¸»è¦åˆ†æ”¯åç¨±ï¼Œä¾‹å¦‚ master
    paths:
      - 'blog/**' # ç›£è½ 'blog/' ç›®éŒ„ä¸‹çš„ä»»ä½•æª”æ¡ˆè®Šå‹•
      - 'blog/**/*' # ç¢ºä¿æ¶µè“‹ 'blog/' å­ç›®éŒ„ä¸­çš„è®Šå‹•

jobs:
  notify_new_post:
    runs-on: ubuntu-latest # åœ¨ Ubuntu ç³»çµ±ä¸ŠåŸ·è¡Œé€™å€‹ job

    steps:
      - name: Checkout repository # æ­¥é©Ÿ 1: æª¢å‡ºæ‚¨çš„å„²å­˜åº«ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          # ç²å–æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Œä»¥ä¾¿ git diff èƒ½æ­£ç¢ºåˆ¤æ–·ã€Œæ–°å¢ã€çš„æª”æ¡ˆ
          fetch-depth: 0 

      - name: Get new files in target directory # æ­¥é©Ÿ 2: å–å¾—æœ¬æ¬¡ push ä¸­æœ‰å“ªäº›æª”æ¡ˆæ˜¯æ–°ã€Œå¢ã€çš„
        id: new-files # çµ¦é€™å€‹æ­¥é©Ÿä¸€å€‹ IDï¼Œä»¥ä¾¿å¾ŒçºŒå¼•ç”¨å…¶è¼¸å‡º
        run: |
          TARGET_DIR="blog/" # è¨­å®šæ‚¨è¦ç›£æ§çš„ç›®éŒ„

          # ç²å–æœ¬æ¬¡ push å¸¶å…¥çš„ commit SHA
          CURRENT_SHA="${{ github.sha }}"
          # ç²å–æœ¬æ¬¡ push ä¹‹å‰ä¸€å€‹ commit çš„ SHAã€‚å¦‚æœé€™æ˜¯ç¬¬ä¸€å€‹ commitï¼Œå‰‡æœƒæ˜¯ç©ºå­—ä¸²ã€‚
          LAST_COMMIT_SHA=$(git rev-parse "${CURRENT_SHA}~1" 2>/dev/null || echo "")

          DETECTED_FILES=""
          if [ -z "$LAST_COMMIT_SHA" ]; then
            # å°æ–¼å„²å­˜åº«çš„ç¬¬ä¸€æ¬¡ pushï¼Œæ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„æ–‡ä»¶éƒ½è¦–ç‚ºã€Œæ–°å¢ã€
            # ç¢ºä¿ find æŒ‡ä»¤èƒ½è™•ç†è·¯å¾‘ä¸­çš„ç©ºç™½å­—å…ƒ
            find "$TARGET_DIR" -type f -print0 | xargs -0 -r -n 1 echo >> temp_new_files.txt
            DETECTED_FILES=$(cat temp_new_files.txt)
          else
            # æ¯”è¼ƒæœ¬æ¬¡ push å’Œä¸Šä¸€å€‹ commit ä¹‹é–“çš„å·®ç•°ï¼Œåªç¯©é¸æ–°å¢çš„æª”æ¡ˆ
            # ä½¿ç”¨ -z å’Œ xargs -0 ä¾†å®‰å…¨è™•ç†æª”åä¸­çš„ç©ºç™½
            git diff --name-only --diff-filter=A "${LAST_COMMIT_SHA}" "${CURRENT_SHA}" -- "$TARGET_DIR" -z | xargs -0 -r -n 1 echo >> temp_new_files.txt
            DETECTED_FILES=$(cat temp_new_files.txt)
          fi

          NEW_POST_FILES=""
          for file in $DETECTED_FILES; do
            # å†æ¬¡ç¢ºèªæª”æ¡ˆæ˜¯åœ¨ç›®æ¨™ç›®éŒ„ä¸‹ (é¿å…æ„å¤–åµæ¸¬åˆ°å…¶ä»–è·¯å¾‘çš„åŒåæª”æ¡ˆ)
            if [[ "$file" == "$TARGET_DIR"* ]]; then
              NEW_POST_FILES="$NEW_POST_FILES $file"
            fi
          done

          echo "Detected NEW files in ${TARGET_DIR} directory: $NEW_POST_FILES"
          # å°‡çµæœè¼¸å‡ºçµ¦ä¸‹ä¸€å€‹æ­¥é©Ÿ
          echo "NEW_POST_FILES=${NEW_POST_FILES}" >> "$GITHUB_OUTPUT" 

      - name: Process and send Telegram notification # æ­¥é©Ÿ 3: è™•ç†æª”æ¡ˆä¸¦ç™¼é€ Telegram é€šçŸ¥
        # åªæœ‰ç•¶ 'Get new files' æ­¥é©Ÿæœ‰åµæ¸¬åˆ°æ–°çš„æ–‡ç« æª”æ¡ˆæ™‚æ‰åŸ·è¡Œ
        if: steps.new-files.outputs.NEW_POST_FILES != ''
        run: |
          # å¾ GitHub Secrets ä¸­å–å¾— Telegram Bot Token å’Œ Chat ID
          TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          
          # å–å¾—ä¸Šä¸€å€‹æ­¥é©Ÿè¼¸å‡ºåµæ¸¬åˆ°çš„æ–°æ–‡ç« æª”æ¡ˆåˆ—è¡¨
          NEW_POST_FILES="${{ steps.new-files.outputs.NEW_POST_FILES }}"
          
          # ã€é‡è¦è¨­å®šã€‘æ‚¨çš„ç¶²ç«™åŸºç¤ç¶²å€
          # è«‹æ ¹æ“šæ‚¨çš„å¯¦éš›éƒ¨è½æ ¼ç¶²å€é€²è¡Œä¿®æ”¹
          BASE_URL="https://holybear.me" 

          # éæ­·æ¯å€‹æ–°å¢çš„æª”æ¡ˆ
          for file_path in $NEW_POST_FILES; do
            echo "Processing file: $file_path"
            
            # è®€å–æª”æ¡ˆå…§å®¹
            file_content=$(cat "$file_path")
            
            # å¾ Markdown æª”æ¡ˆå…§å®¹ä¸­æå– title (å„ªå…ˆå¾ Front Matter æå–)
            TITLE=""
            TITLE=$(echo "$file_content" | awk '
              /^---$/ { count++; if (count == 2) exit; next }
              (count == 1 && /^\s*title:/) { 
                gsub(/^\s*title:\s*/, "", $0); 
                gsub(/\r/, "", $0);
                print $0; 
                exit
              }
            ')
            
            # å¦‚æœ Front Matter ä¸­æ²’æœ‰ titleï¼Œå‰‡å˜—è©¦å¾ H1 æ¨™é¡Œæå–
            if [ -z "$TITLE" ]; then
              TITLE=$(echo "$file_content" | grep -iE '^#\s*(.*)' | head -n 1 | sed -E 's/^#\s*(.*)/\1/' | tr -d '\r')
            fi

            # å¦‚æœä»ç„¶æ²’æœ‰æ¨™é¡Œï¼Œè¨­å®šç‚ºé è¨­å€¼
            if [ -z "$TITLE" ]; then
              TITLE="ç„¡æ¨™é¡Œæ–‡ç« "
            fi

            # ã€æ–°å¢ã€‘å¾ Markdown æª”æ¡ˆå…§å®¹ä¸­æå– category (å„ªå…ˆå¾ Front Matter æå–ç¬¬ä¸€å€‹)
            CATEGORY=""
            CATEGORY=$(echo "$file_content" | awk '
              /^---$/ { count++; if (count == 2) exit; next }
              (count == 1 && /^\s*category:\s*\[/) {
                # æå– category é™£åˆ—çš„ç¬¬ä¸€å€‹å…ƒç´ 
                gsub(/^\s*category:\s*\[/, "", $0);
                gsub(/\].*$/, "", $0);
                split($0, categories, ",");
                gsub(/['" ]/, "", categories[1]); # ç§»é™¤å–®å¼•è™Ÿã€é›™å¼•è™Ÿã€ç©ºç™½
                print categories[1];
                exit
              }
              (count == 1 && /^\s*category:\s*[^\[]*/) { # è™•ç†å–®ä¸€ category æ²’æœ‰é™£åˆ—ç¬¦è™Ÿçš„æƒ…æ³
                gsub(/^\s*category:\s*/, "", $0);
                gsub(/\r/, "", $0);
                gsub(/['" ]/, "", $0); # ç§»é™¤å¼•è™Ÿå’Œç©ºç™½
                print $0;
                exit
              }
            ')
            
            # å¦‚æœæœ‰ categoryï¼Œå‰‡å°‡æ¨™é¡ŒåŠ ä¸Šå‰ç¶´
            if [ -n "$CATEGORY" ]; then
              TITLE="ã€${CATEGORY}ã€‘${TITLE}"
            fi

            # ç”¢ç”Ÿæ–‡ç« é€£çµçš„é‚è¼¯
            # ç§»é™¤ 'blog/' å‰ç¶´å’Œå‰¯æª”åï¼Œä¸¦æ›¿æ›ç‚ºç¶²ç«™ URL æ ¼å¼ (ä¾‹å¦‚ï¼šå¾ blog/my-article.md è½‰æˆ my-article)
            ARTICLE_SLUG=$(echo "$file_path" | sed -E 's|^blog/(.*)\.md$|\1|')
            
            # çµ„åˆæˆå®Œæ•´çš„æ–‡ç« é€£çµ (ä¾‹å¦‚ï¼šhttps://holybear.me/blog/my-article/)
            ARTICLE_URL="${BASE_URL}/blog/${ARTICLE_SLUG}/" 


            # çµ„è£ Telegram è¨Šæ¯ (ç°¡æ½”ç‰ˆï¼Œç§»é™¤å„²å­˜åº«ã€è·¯å¾‘ã€æŸ¥çœ‹è®Šå‹•)
            MESSAGE="ğŸ“¢ **æ–°æ–‡ç« é€šçŸ¥ï¼**\n"
            MESSAGE+="æ¨™é¡Œï¼š**${TITLE}**\n"
            MESSAGE+="ä½œè€…ï¼š${{ github.actor }}\n"
            MESSAGE+="[é»æ­¤é–±è®€æ–‡ç« ](${ARTICLE_URL})\n" 
            MESSAGE+="æäº¤è¨Šæ¯ï¼š\`${{ github.event.head_commit.message }}\`" # æ”¾åœ¨æœ€å¾Œï¼Œä¸å†å¼·åˆ¶æ›è¡Œ

            # ç™¼é€ Telegram è¨Šæ¯
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{
                \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
                \"text\": \"$(echo "${MESSAGE}" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')\",
                \"parse_mode\": \"Markdown\"
              }"
            echo "Telegram notification sent for $file_path with title: $TITLE"
          done
        env: # å°‡ç’°å¢ƒè®Šæ•¸è¨­å®šåœ¨é€™è£¡ï¼Œé¿å…ç›´æ¥å¯«åœ¨ run å€å¡Šä¸­
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
