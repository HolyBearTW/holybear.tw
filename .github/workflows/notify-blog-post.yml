name: Notify New Blog Post to Telegram # å·¥ä½œæµç¨‹åç¨±

# ç•¶æœ‰æ–°çš„ push äº‹ä»¶ç™¼ç”Ÿæ™‚è§¸ç™¼æ­¤ workflow
on:
  push:
    branches:
      - main # è«‹å°‡æ­¤è™•æ”¹ç‚ºæ‚¨å„²å­˜åº«çš„ä¸»è¦åˆ†æ”¯åç¨±ï¼Œä¾‹å¦‚ master
    paths:
      - 'blog/**' # ç›£è½ 'blog/' ç›®éŒ„ä¸‹çš„ä»»ä½•æª”æ¡ˆè®Šå‹•
      - 'blog/**/*' # ç¢ºä¿æ¶µè“‹ 'blog/' å­ç›®éŒ„ä¸­çš„è®Šå‹•

jobs:
  notify_new_post:
    runs-on: ubuntu-latest # åœ¨ Ubuntu ç³»çµ±ä¸ŠåŸ·è¡Œé€™å€‹ job

    steps:
      - name: Checkout repository # æ­¥é©Ÿ 1: æª¢å‡ºæ‚¨çš„å„²å­˜åº«ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          # ç²å–æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Œä»¥ä¾¿ git diff èƒ½æ­£ç¢ºåˆ¤æ–·ã€Œæ–°å¢ã€çš„æª”æ¡ˆ
          fetch-depth: 0

      - name: Get new files in target directory # æ­¥é©Ÿ 2: å–å¾—æœ¬æ¬¡ push ä¸­æœ‰å“ªäº›æª”æ¡ˆæ˜¯æ–°ã€Œå¢ã€çš„
        id: new-files # çµ¦é€™å€‹æ­¥é©Ÿä¸€å€‹ IDï¼Œä»¥ä¾¿å¾ŒçºŒå¼•ç”¨å…¶è¼¸å‡º
        run: |
          TARGET_DIR="blog/" # è¨­å®šæ‚¨è¦ç›£æ§çš„ç›®éŒ„

          # ç²å–æœ¬æ¬¡ push å¸¶å…¥çš„ commit SHA
          CURRENT_SHA="${{ github.sha }}"
          # ç²å–æœ¬æ¬¡ push ä¹‹å‰ä¸€å€‹ commit çš„ SHAã€‚å¦‚æœé€™æ˜¯ç¬¬ä¸€å€‹ commitï¼Œå‰‡æœƒæ˜¯ç©ºå­—ä¸²ã€‚
          LAST_COMMIT_SHA=$(git rev-parse "${CURRENT_SHA}~1" 2>/dev/null || echo "")

          DETECTED_FILES=""
          if [ -z "$LAST_COMMIT_SHA" ]; then
            # å°æ–¼å„²å­˜åº«çš„ç¬¬ä¸€æ¬¡ pushï¼Œæ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„æ–‡ä»¶éƒ½è¦–ç‚ºã€Œæ–°å¢ã€
            # ç¢ºä¿ find æŒ‡ä»¤èƒ½è™•ç†è·¯å¾‘ä¸­çš„ç©ºç™½å­—å…ƒ
            find "$TARGET_DIR" -type f -print0 | xargs -0 -r -n 1 echo >> temp_new_files.txt
            DETECTED_FILES=$(cat temp_new_files.txt)
          else
            # æ¯”è¼ƒæœ¬æ¬¡ push å’Œä¸Šä¸€å€‹ commit ä¹‹é–“çš„å·®ç•°ï¼Œåªç¯©é¸æ–°å¢çš„æª”æ¡ˆ
            # ä½¿ç”¨ -z å’Œ xargs -0 ä¾†å®‰å…¨è™•ç†æª”åä¸­çš„ç©ºç™½
            git diff --name-only --diff-filter=A "${LAST_COMMIT_SHA}" "${CURRENT_SHA}" -- "$TARGET_DIR" -z | xargs -0 -r -n 1 echo >> temp_new_files.txt
            DETECTED_FILES=$(cat temp_new_files.txt)
          fi

          NEW_POST_FILES=""
          for file in $DETECTED_FILES; do
            # å†æ¬¡ç¢ºèªæª”æ¡ˆæ˜¯åœ¨ç›®æ¨™ç›®éŒ„ä¸‹ (é¿å…æ„å¤–åµæ¸¬åˆ°å…¶ä»–è·¯å¾‘çš„åŒåæª”æ¡ˆ)
            if [[ "$file" == "$TARGET_DIR"* ]]; then
              NEW_POST_FILES="$NEW_POST_FILES $file"
            fi
          done

          echo "Detected NEW files in ${TARGET_DIR} directory: $NEW_POST_FILES"
          # å°‡çµæœè¼¸å‡ºçµ¦ä¸‹ä¸€å€‹æ­¥é©Ÿ
          echo "NEW_POST_FILES=${NEW_POST_FILES}" >> "$GITHUB_OUTPUT"

      - name: Process and send Telegram notification # è™•ç†æª”æ¡ˆä¸¦ç™¼é€ Telegram é€šçŸ¥
        # åªæœ‰ç•¶ 'Get new files' æ­¥é©Ÿæœ‰åµæ¸¬åˆ°æ–°çš„æ–‡ç« æª”æ¡ˆæ™‚æ‰åŸ·è¡Œ
        if: steps.new-files.outputs.NEW_POST_FILES != ''
        run: |
          # å¾ GitHub Secrets ä¸­å–å¾— Telegram Bot Token å’Œ Chat ID
          TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          
          # å–å¾—ä¸Šä¸€å€‹æ­¥é©Ÿè¼¸å‡ºåµæ¸¬åˆ°çš„æ–°æ–‡ç« æª”æ¡ˆåˆ—è¡¨
          NEW_POST_FILES="${{ steps.new-files.outputs.NEW_POST_FILES }}"
          
          # ã€é‡è¦è¨­å®šã€‘æ‚¨çš„ç¶²ç«™åŸºç¤ç¶²å€
          # è«‹æ ¹æ“šæ‚¨çš„å¯¦éš›éƒ¨è½æ ¼ç¶²å€é€²è¡Œä¿®æ”¹
          BASE_URL="https://holybear.me"

          # å‡½å¼ï¼šå°å­—ä¸²é€²è¡Œ MarkdownV2 ç‰¹æ®Šå­—å…ƒè·³è„«
          # é€™æ˜¯æœ€ç©©å®šçš„ Bash sed å¯«æ³•ï¼Œè™•ç†æ‰€æœ‰ MarkdownV2 ä¿ç•™å­—å…ƒ
          # å®˜æ–¹å®Œæ•´åˆ—è¡¨ï¼š_ * [ ] ( ) ~ ` > # + - = | { } . ! \
          escape_markdownv2() {
            local text="$1"
            # ä½¿ç”¨å–®ä¸€çš„ sed æ›¿æ›å‘½ä»¤ï¼Œç²¾ç¢ºè·³è„«æ‰€æœ‰ä¿ç•™å­—å…ƒ
            # é€™å€‹æ­£å‰‡è¡¨é”å¼åŒ¹é…æ‰€æœ‰éœ€è¦åœ¨ MarkdownV2 ä¸­è·³è„«çš„å­—å…ƒ
            # ä¸¦ä¸”æœƒè™•ç† \ (åæ–œç·šæœ¬èº«) çš„è·³è„«
            text=$(echo "$text" | sed -E 's/([_*\\[\\]()~`>#\+\-=\|\{\}\.!\\\\])/\\\1/g')
            echo "$text"
          }
          
          # éæ­·æ¯å€‹æ–°å¢çš„æª”æ¡ˆ
          for file_path in $NEW_POST_FILES; do
            echo "Processing file: $file_path"
            
            # è®€å–æª”æ¡ˆå…§å®¹
            file_content=$(cat "$file_path")
            
            # å¾ Markdown æª”æ¡ˆå…§å®¹ä¸­æå– title (å„ªå…ˆå¾ Front Matter æå–)
            TITLE=""
            TITLE=$(echo "$file_content" | awk '
              /^---$/ { count++; if (count == 2) exit; next }
              (count == 1 && /^\s*title:/) { 
                gsub(/^\s*title:\s*/, "", $0); 
                gsub(/\r/, "", $0);
                print $0; 
                exit
              }
            ')
            
            # å¦‚æœ Front Matter ä¸­æ²’æœ‰ titleï¼Œå‰‡å˜—è©¦å¾ H1 æ¨™é¡Œæå–
            if [ -z "$TITLE" ]; then
              TITLE=$(echo "$file_content" | grep -iE '^#\s*(.*)' | head -n 1 | sed -E 's/^#\s*(.*)/\1/' | tr -d '\r')
            fi

            # å¦‚æœä»ç„¶æ²’æœ‰æ¨™é¡Œï¼Œè¨­å®šç‚ºé è¨­å€¼
            if [ -z "$TITLE" ]; then
              TITLE="ç„¡æ¨™é¡Œæ–‡ç« "
            fi

            # æå– category
            CATEGORY=""
            CATEGORY=$(echo "$file_content" | grep -A 1 -E '^\s*category:' | grep -E '^\s*-\s*' | head -n 1 | sed -E 's/^\s*-\s*(.*)/\1/' | tr -d '\r')
            if [ -z "$CATEGORY" ]; then
              CATEGORY=$(echo "$file_content" | grep -iE '^\s*category:\s*\[.*\]' | head -n 1 | sed -E 's/^\s*category:\s*\[(.*)\].*/\1/' | cut -d',' -f1 | tr -d '\r')
            fi
            if [ -z "$CATEGORY" ]; then
              CATEGORY=$(echo "$file_content" | grep -iE '^\s*category:\s*[^\[-]' | head -n 1 | sed -E 's/^\s*category:\s*(.*)/\1/' | tr -d '\r')
            fi
            CATEGORY=$(echo "$CATEGORY" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')
            CATEGORY=$(echo "$CATEGORY" | sed -E 's/[\x27"\/]//g')

            # å¦‚æœæˆåŠŸæå–åˆ°é¡åˆ¥ï¼Œå‰‡å°‡æ¨™é¡ŒåŠ ä¸Šå‰ç¶´
            # é€™è£¡ TITLE æœ¬èº«è¦å…ˆè·³è„«ï¼Œç„¶å¾Œå†çµ„è£
            ESCAPED_TITLE=$(escape_markdownv2 "$TITLE")
            if [ -n "$CATEGORY" ]; then
              ESCAPED_CATEGORY=$(escape_markdownv2 "$CATEGORY")
              ESCAPED_TITLE="ã€${ESCAPED_CATEGORY}ã€‘${ESCAPED_TITLE}" # ä¸éœ€è¦è·³è„« ã€ã€‘ å› ç‚ºå®ƒä¸æ˜¯MarkdownV2ä¿ç•™å­—å…ƒ
            fi
            
            # ç”¢ç”Ÿæ–‡ç« é€£çµçš„é‚è¼¯
            ARTICLE_SLUG=$(echo "$file_path" | sed -E 's|^blog/(.*)\.md$|\1|')
            # ç¶²å€æœ¬èº«ä¸éœ€è¦è·³è„«ï¼Œå› ç‚ºå®ƒåœ¨é€£çµèªæ³•çš„æ‹¬è™Ÿå…§éƒ¨
            ARTICLE_URL="${BASE_URL}/blog/${ARTICLE_SLUG}.html" 

            # è·³è„« commit è¨Šæ¯
            ESCAPED_COMMIT_MESSAGE=$(escape_markdownv2 "${{ github.event.head_commit.message }}")
            
            # ** ä¿®æ­£ï¼šç¢ºä¿ä½œè€…åç¨±é¡¯ç¤ºç‚ºåŸå§‹è®Šæ•¸åç¨±ä¸¦ä»¥ç­‰å¯¬å­—é«”å‘ˆç¾ **
            # å°‡è®Šæ•¸åç¨±çš„å­—ä¸²æœ¬èº«é€²è¡Œè·³è„«
            ESCAPED_RAW_AUTHOR_VAR_NAME=$(escape_markdownv2 "github.event.head_commit.author.name")

            # çµ„è£ Telegram è¨Šæ¯ (MarkdownV2 æ ¼å¼)
            MESSAGE="*ğŸ“¢ New push to GitHub*\n" # GitHub æ¨æ’­é€šçŸ¥ï¼Œç²—é«”
            MESSAGE+="*${ESCAPED_TITLE}*\n" # æ–‡ç« æ¨™é¡Œï¼Œç²—é«”
            MESSAGE+="\`\`\`${ESCAPED_COMMIT_MESSAGE}\`\`\`\n" # æäº¤è¨Šæ¯å…§å®¹ï¼Œç­‰å¯¬å­—é«”
            MESSAGE+="[\\>\\>é»æ­¤é–±è®€æ–‡ç« ](${ARTICLE_URL})\n" # æ–‡ç« é€£çµï¼Œ`>` ç¬¦è™Ÿè·³è„«
            MESSAGE+="by \`${ESCAPED_RAW_AUTHOR_VAR_NAME}\`"

            # ç™¼é€ Telegram è¨Šæ¯
            # å°‡è¨Šæ¯å…§å®¹å‚³éçµ¦ curlï¼Œä¸¦æŒ‡å®š parse_mode ç‚º MarkdownV2 å’Œ disable_web_page_preview
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{
                \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
                \"text\": \"$(echo "${MESSAGE}" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')\",
                \"parse_mode\": \"MarkdownV2\",
                \"disable_web_page_preview\": true
              }"
            echo "Telegram notification sent for $file_path with title: $TITLE"
          done
