name: Deploy Blog & Notify New Post to Telegram # å·¥ä½œæµç¨‹åç¨±ï¼Œæ”¹ç‚ºéƒ¨ç½²èˆ‡é€šçŸ¥

# ç•¶æœ‰æ–°çš„ push äº‹ä»¶ç™¼ç”Ÿæ™‚è§¸ç™¼æ­¤ workflow
on:
  push:
    branches:
      - main # è«‹å°‡æ­¤è™•æ”¹ç‚ºæ‚¨å„²å­˜åº«çš„ä¸»è¦åˆ†æ”¯åç¨±ï¼Œä¾‹å¦‚ master
    paths:
      - 'blog/**' # ç›£è½ 'blog/' ç›®éŒ„ä¸‹çš„ä»»ä½•æª”æ¡ˆè®Šå‹•
      - 'blog/**/*' # ç¢ºä¿æ¶µè“‹ 'blog/' å­ç›®éŒ„ä¸­çš„è®Šå‹•

jobs:
  # --- ç¬¬ä¸€å€‹ Job: è² è²¬å»ºç½®å’Œéƒ¨ç½² GitHub Pages ---
  build_and_deploy_pages:
    runs-on: ubuntu-latest
    # ã€é‡è¦ã€‘è¨­å®š environmentï¼Œé€™æ˜¯ GitHub Pages éƒ¨ç½²æ‰€éœ€çš„
    environment:
      name: github-pages
    permissions:
      contents: read
      pages: write # éƒ¨ç½² Pages éœ€è¦å¯«å…¥æ¬Šé™
      id-token: write # éƒ¨ç½² Pages éœ€è¦é€™å€‹æ¬Šé™

    outputs:
      # å°‡åµæ¸¬åˆ°çš„æ–°æª”æ¡ˆåˆ—è¡¨è¼¸å‡ºï¼Œä¾›å¾ŒçºŒ notify_new_post job ä½¿ç”¨
      new_post_files: ${{ steps.get-new-files.outputs.NEW_POST_FILES }}

    steps:
      - name: Checkout repository for build
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ç²å–æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Œä»¥ä¾¿ git diff èƒ½æ­£ç¢ºåˆ¤æ–·ã€Œæ–°å¢ã€çš„æª”æ¡ˆ

      - name: Get new files in target directory (for decision making)
        id: get-new-files # ä¿ç•™ ID ä»¥ä¾¿è¼¸å‡º
        run: |
          TARGET_DIR="blog/"
          CURRENT_SHA="${{ github.sha }}"
          LAST_COMMIT_SHA=$(git rev-parse "${CURRENT_SHA}~1" 2>/dev/null || echo "")

          DETECTED_FILES=""
          if [ -z "$LAST_COMMIT_SHA" ]; then
            # å°æ–¼å„²å­˜åº«çš„ç¬¬ä¸€æ¬¡ pushï¼Œæ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„æ–‡ä»¶éƒ½è¦–ç‚ºã€Œæ–°å¢ã€
            # ç¢ºä¿ find æŒ‡ä»¤èƒ½è™•ç†è·¯å¾‘ä¸­çš„ç©ºç™½å­—å…ƒ
            find "$TARGET_DIR" -type f -print0 | xargs -0 -r -n 1 echo >> temp_new_files.txt
            DETECTED_FILES=$(cat temp_new_files.txt)
          else
            # æ¯”è¼ƒæœ¬æ¬¡ push å’Œä¸Šä¸€å€‹ commit ä¹‹é–“çš„å·®ç•°ï¼Œåªç¯©é¸æ–°å¢çš„æª”æ¡ˆ
            # ä½¿ç”¨ -z å’Œ xargs -0 ä¾†å®‰å…¨è™•ç†æª”åä¸­çš„ç©ºç™½
            git diff --name-only --diff-filter=A "${LAST_COMMIT_SHA}" "${CURRENT_SHA}" -- "$TARGET_DIR" -z | xargs -0 -r -n 1 echo >> temp_new_files.txt
            DETECTED_FILES=$(cat temp_new_files.txt)
          fi

          NEW_POST_FILES=""
          # ç‚ºäº†å®‰å…¨è™•ç†æª”åä¸­çš„ç©ºç™½å­—å…ƒï¼Œè¨­å®š IFS ç‚ºæ›è¡Œç¬¦è™Ÿ
          IFS=$'\n'
          for file in $DETECTED_FILES; do
            # å†æ¬¡ç¢ºèªæª”æ¡ˆæ˜¯åœ¨ç›®æ¨™ç›®éŒ„ä¸‹ (é¿å…æ„å¤–åµæ¸¬åˆ°å…¶ä»–è·¯å¾‘çš„åŒåæª”æ¡ˆ)
            if [[ "$file" == "$TARGET_DIR"* ]]; then
              NEW_POST_FILES="$NEW_POST_FILES
$file" # é€™è£¡ä½¿ç”¨æ›è¡Œç¬¦è™Ÿåˆ†éš”
            fi
          done

          echo "Detected NEW files in ${TARGET_DIR} directory: ${NEW_POST_FILES}"
          echo "NEW_POST_FILES=${NEW_POST_FILES}" >> "$GITHUB_OUTPUT"

      # --- ã€é€™è£¡æ”¾æ‚¨çš„éƒ¨è½æ ¼å»ºç½®æŒ‡ä»¤ã€‘ ---
      # é€™å€‹æ­¥é©Ÿæœƒç”Ÿæˆæ‚¨çš„éœæ…‹ç¶²ç«™æª”æ¡ˆï¼Œä¸¦æ”¾åˆ° _site æˆ– public ç›®éŒ„
      - name: Build Your Blog
        # è«‹åœ¨é€™è£¡æ›¿æ›æˆæ‚¨å¯¦éš›éƒ¨è½æ ¼çš„å»ºç½®æŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼š
        # run: bundle install && bundle exec jekyll build
        # run: hugo
        # run: npm install && hexo generate
        run: |
          echo "é€™è£¡æ˜¯æ‚¨éƒ¨è½æ ¼çš„å»ºç½®æŒ‡ä»¤ã€‚å®ƒæœƒç”¢ç”Ÿéœæ…‹æª”æ¡ˆåˆ° _site æˆ– public ç›®éŒ„ã€‚"
          # ä»¥ä¸‹æ˜¯ç‚ºäº†ç¤ºç¯„è€Œæ”¾ç½®çš„æ¨¡æ“¬æŒ‡ä»¤ï¼Œè«‹å‹™å¿…æ›¿æ›ç‚ºæ‚¨çœŸå¯¦çš„å»ºç½®æŒ‡ä»¤
          mkdir -p _site 
          echo "<h1>é€™æ˜¯é¦–é </h1>" > _site/index.html
          mkdir -p _site/blog
          echo "<h1>Hello World! é€™æ˜¯ä¸€ç¯‡æ–°æ–‡ç« </h1>" > _site/blog/first-new-article.html
          # æ¨¡æ“¬æŒ‡ä»¤çµæŸï¼Œè«‹ç§»é™¤æˆ–æ›¿æ›ä¸Šæ–¹é€™äº›æ¨¡æ“¬æŒ‡ä»¤ç‚ºæ‚¨çœŸå¯¦çš„å»ºç½®æŒ‡ä»¤

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site' # ç¢ºä¿é€™è£¡çš„è·¯å¾‘èˆ‡æ‚¨éƒ¨è½æ ¼å¯¦éš›çš„è¼¸å‡ºç›®éŒ„ä¸€è‡´ (ä¾‹å¦‚ _site æˆ– public)

      - name: Deploy to GitHub Pages
        id: deployment # çµ¦é€™å€‹æ­¥é©Ÿä¸€å€‹ IDï¼Œæ–¹ä¾¿å¾ŒçºŒå¼•ç”¨
        uses: actions/deploy-pages@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # --- ç¬¬äºŒå€‹ Job: ç™¼é€ Telegram é€šçŸ¥ (åœ¨ Pages éƒ¨ç½²æˆåŠŸå¾Œ) ---
  notify_new_post:
    runs-on: ubuntu-latest
    needs: build_and_deploy_pages # <--- ã€é—œéµã€‘é€™å€‹ Job æœƒåœ¨ build_and_deploy_pages æˆåŠŸå¾Œæ‰åŸ·è¡Œ

    # åªæœ‰ç•¶ build_and_deploy_pages æˆåŠŸä¸”æœ‰æ–°æª”æ¡ˆè¢«åµæ¸¬åˆ°æ™‚æ‰åŸ·è¡Œé€šçŸ¥
    if: success() && needs.build_and_deploy_pages.outputs.new_post_files != ''

    steps:
      - name: Checkout repository # é‡æ–°æª¢å‡ºï¼Œä»¥ä¾¿è®€å–æ–‡ç« å…§å®¹
        uses: actions/checkout@v4
        # é€™è£¡ä¸éœ€è¦ fetch-depth: 0ï¼Œå› ç‚ºæˆ‘å€‘åªè®€å–æª”æ¡ˆ

      - name: Process and send Telegram notification # æ­¥é©Ÿ 3: è™•ç†æª”æ¡ˆä¸¦ç™¼é€ Telegram é€šçŸ¥
        run: |
          TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"

          # å¾ä¸Šä¸€å€‹ Job ç²å–åµæ¸¬åˆ°çš„æ–°æ–‡ç« æª”æ¡ˆåˆ—è¡¨
          # é€™è£¡ä½¿ç”¨é›™å¼•è™Ÿï¼Œç¢ºä¿æ­£ç¢ºè™•ç†æª”åä¸­çš„ç©ºç™½
          NEW_POST_FILES="${{ needs.build_and_deploy_pages.outputs.new_post_files }}"
          
          # ã€é‡è¦è¨­å®šã€‘æ‚¨çš„ç¶²ç«™åŸºç¤ç¶²å€
          BASE_URL="https://holybear.me"

          # éæ­·æ¯å€‹æ–°å¢çš„æª”æ¡ˆ
          # æ³¨æ„ï¼šç‚ºäº†å®‰å…¨è™•ç†æª”åä¸­çš„ç©ºç™½ï¼Œé€™è£¡ä½¿ç”¨ IFS å’Œ read -r
          IFS=$'\n' # è¨­å®šå…§éƒ¨æ¬„ä½åˆ†éš”ç¬¦ç‚ºæ›è¡Œç¬¦ï¼Œç¢ºä¿æª”åä¸­çš„ç©ºç™½ä¸æœƒè¢«éŒ¯èª¤åœ°æ‹†åˆ†
          for file_path in ${NEW_POST_FILES}; do # é€™è£¡ä¹Ÿä½¿ç”¨é›™å¼•è™Ÿ
            echo "Processing file: ${file_path}"
            
            # è®€å–æª”æ¡ˆå…§å®¹
            file_content=$(cat "${file_path}") # åŠ ä¸Šé›™å¼•è™Ÿ
            
            # å¾ Markdown æª”æ¡ˆå…§å®¹ä¸­æå– title (å„ªå…ˆå¾ Front Matter æå–)
            TITLE=""
            TITLE=$(echo "${file_content}" | awk ' # åŠ ä¸Šé›™å¼•è™Ÿ
              /^---$/ { count++; if (count == 2) exit; next }
              (count == 1 && /^\s*title:/) { 
                gsub(/^\s*title:\s*/, "", $0); 
                gsub(/\r/, "", $0);
                print $0; 
                exit
              }
            ')
            
            if [ -z "${TITLE}" ]; then # åŠ ä¸Šé›™å¼•è™Ÿ
              TITLE=$(echo "${file_content}" | grep -iE '^#\s*(.*)' | head -n 1 | sed -E 's/^#\s*(.*)/\1/' | tr -d '\r')
            fi
            if [ -z "${TITLE}" ]; then # åŠ ä¸Šé›™å¼•è™Ÿ
              TITLE="ç„¡æ¨™é¡Œæ–‡ç« "
            fi

            # ã€æœ€æ–°ä¿®æ­£ã€‘ä½¿ç”¨ grep å’Œ sed ä¾†æå– categoryï¼Œæ›´ç©©å®šè™•ç†å¤šç¨® YAML æ ¼å¼
            CATEGORY=""
            CATEGORY=$(echo "${file_content}" | grep -A 1 -E '^\s*category:' | grep -E '^\s*-\s*' | head -n 1 | sed -E 's/^\s*-\s*(.*)/\1/' | tr -d '\r')
            if [ -z "${CATEGORY}" ]; then # åŠ ä¸Šé›™å¼•è™Ÿ
              CATEGORY=$(echo "${file_content}" | grep -iE '^\s*category:\s*\[.*\]' | head -n 1 | sed -E 's/^\s*category:\s*\[(.*)\].*/\1/' | cut -d',' -f1 | tr -d '\r')
            fi
            if [ -z "${CATEGORY}" ]; then # åŠ ä¸Šé›™å¼•è™Ÿ
              CATEGORY=$(echo "${file_content}" | grep -iE '^\s*category:\s*[^\[-]' | head -n 1 | sed -E 's/^\s*category:\s*(.*)/\1/' | tr -d '\r')
            fi
            CATEGORY=$(echo "${CATEGORY}" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')
            CATEGORY=$(echo "${CATEGORY}" | sed -E 's/[\x27"\/]//g')

            if [ -n "${CATEGORY}" ]; then # åŠ ä¸Šé›™å¼•è™Ÿ
                TITLE="ã€${CATEGORY}ã€‘${TITLE}" # è®Šæ•¸ä¹ŸåŠ ä¸Šé›™å¼•è™Ÿ
            fi

            # ç”¢ç”Ÿæ–‡ç« é€£çµçš„é‚è¼¯
            ARTICLE_SLUG=$(echo "${file_path}" | sed -E 's|^blog/(.*)\.md$|\1|') # åŠ ä¸Šé›™å¼•è™Ÿ
            ARTICLE_URL="${BASE_URL}/blog/${ARTICLE_SLUG}.html" # å‡è¨­æ‚¨çš„æ–‡ç« æ˜¯ .html çµå°¾ï¼Œç¢ºä¿è®Šæ•¸åŠ ä¸Šé›™å¼•è™Ÿ

            # çµ„è£ Telegram è¨Šæ¯
            # é€™è£¡çš„ MESSAGE è®Šæ•¸ï¼Œå› ç‚ºæ˜¯ç”¨ += ä¸²æ¥ï¼Œè¦ç¢ºä¿å…§å®¹éƒ½ç”¨é›™å¼•è™Ÿ
            MESSAGE="**ğŸ“¢ New push to GitHub**\n"
            MESSAGE+="**${TITLE}**\n"
            MESSAGE+="```${{ github.event.head_commit.message }}```\n" # é€™è£¡ ${{...}} æœƒç›´æ¥è¼¸å‡º
            MESSAGE+="[>>é»æ­¤é–±è®€æ–‡ç« ](${ARTICLE_URL})\n"
            MESSAGE+="by ${{ github.event.head_commit.author.name }}"

            # ç™¼é€ Telegram è¨Šæ¯
            # ã€é‡è¦ã€‘é€™è£¡é‡æ–°èª¿æ•´ URL ç·¨ç¢¼æ–¹å¼ï¼Œä»¥æ”¯æ´ MarkdownV2ï¼Œç¢ºä¿ Telegram æ­£å¸¸è§£æ
            ENCODED_MESSAGE=$(echo -e "${MESSAGE}" | sed -E 's/([_*\[\]()~`>#+\-=\|{}!.\\])/\\\1/g' | sed 's/ /%20/g' | sed 's/\n/%0A/g' | sed 's/\*/%2A/g' | sed 's/\[/%5B/g' | sed 's/\]/%5D/g' | sed 's/(/%28/g' | sed 's/)/%29/g' | sed 's/`/%60/g' | sed 's/{/%7B/g' | sed 's/}/%7D/g' | sed 's/~/%7E/g' | sed 's/\./%2E/g')

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${ENCODED_MESSAGE}" \
              -d "parse_mode=MarkdownV2" # ç¢ºä¿é€™è£¡ä½¿ç”¨ MarkdownV2
            echo "Telegram notification sent for ${file_path} with title: ${TITLE}" # æœ€å¾Œçš„ echo ä¹ŸåŠ ä¸Šé›™å¼•è™Ÿ
          done
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
