name: Notify New Blog Post to Telegram # å·¥ä½œæµç¨‹åç¨±ï¼šç•¶æœ‰æ–°çš„éƒ¨è½æ ¼æ–‡ç« æ™‚ï¼Œç™¼é€é€šçŸ¥åˆ° Telegram

# ç•¶æœ‰æ–°çš„ push äº‹ä»¶ç™¼ç”Ÿæ™‚è§¸ç™¼æ­¤ workflow
on:
  push:
    branches:
      - main # è«‹å°‡æ­¤è™•æ”¹ç‚ºæ‚¨å„²å­˜åº«çš„ä¸»è¦åˆ†æ”¯åç¨±ï¼Œä¾‹å¦‚ master
    # ç›£è½ç‰¹å®šè·¯å¾‘çš„è®Šå‹•
    paths:
      - 'blog/**' # ç›£è½ 'blog/' ç›®éŒ„ä¸‹çš„ä»»ä½•æª”æ¡ˆè®Šå‹•
      - 'blog/**/*' # ç¢ºä¿æ¶µè“‹ 'blog/' å­ç›®éŒ„ä¸­çš„è®Šå‹•
      - '**' # ç›£è½æ‰€æœ‰è·¯å¾‘çš„è®Šå‹•ï¼Œä»¥ä¾¿åµæ¸¬é blog è·¯å¾‘çš„æäº¤

jobs:
  notify_new_post:
    runs-on: ubuntu-latest # åœ¨ Ubuntu ç³»çµ±ä¸ŠåŸ·è¡Œé€™å€‹ job

    steps:
      - name: Checkout repository # æ­¥é©Ÿ 1: æª¢å‡ºæ‚¨çš„å„²å­˜åº«ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          # ç²å–æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Œä»¥ä¾¿ git diff èƒ½æ­£ç¢ºåˆ¤æ–·ã€Œæ–°å¢ã€çš„æª”æ¡ˆ
          fetch-depth: 0

      - name: Determine if blog post or other change # æ­¥é©Ÿ 2: åˆ¤æ–·æ˜¯éƒ¨è½æ ¼æ–‡ç« æ›´æ–°é‚„æ˜¯å…¶ä»–é¡å‹è®Šæ›´
        id: change-type # çµ¦é€™å€‹æ­¥é©Ÿä¸€å€‹ IDï¼Œä»¥ä¾¿å¾ŒçºŒå¼•ç”¨å…¶è¼¸å‡º
        run: |
          # æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•è®Šæ›´ç™¼ç”Ÿåœ¨ 'blog/' ç›®éŒ„ä¸‹
          # å¦‚æœæœ‰ï¼Œè¡¨ç¤ºæ˜¯æ–°çš„éƒ¨è½æ ¼æ–‡ç« ï¼›å¦‚æœæ²’æœ‰ï¼Œå‰‡è¦–ç‚ºå…¶ä»–æäº¤ä¿®å¾©
          
          # ç²å–æœ¬æ¬¡ push å¸¶å…¥çš„ commit SHA
          CURRENT_SHA="${{ github.sha }}"
          # ç²å–æœ¬æ¬¡ push ä¹‹å‰ä¸€å€‹ commit çš„ SHAã€‚å¦‚æœé€™æ˜¯ç¬¬ä¸€å€‹ commitï¼Œå‰‡æœƒæ˜¯ç©ºå­—ä¸²ã€‚
          LAST_COMMIT_SHA=$(git rev-parse "${CURRENT_SHA}~1" 2>/dev/null || echo "")

          # åµæ¸¬ 'blog/' ç›®éŒ„ä¸‹çš„æ–°å¢æª”æ¡ˆ
          BLOG_NEW_FILES=""
          if [ -z "$LAST_COMMIT_SHA" ]; then
            # å°æ–¼å„²å­˜åº«çš„ç¬¬ä¸€æ¬¡ pushï¼Œæ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„æ–‡ä»¶éƒ½è¦–ç‚ºã€Œæ–°å¢ã€
            if find blog/ -maxdepth 1 -type f -print -quit | grep -q .; then
                echo "IS_BLOG_POST=true" >> "$GITHUB_OUTPUT"
            else
                echo "IS_BLOG_POST=false" >> "$GITHUB_OUTPUT"
            fi
          else
            # æ¯”è¼ƒæœ¬æ¬¡ push å’Œä¸Šä¸€å€‹ commit ä¹‹é–“çš„å·®ç•°ï¼Œåªç¯©é¸æ–°å¢çš„æª”æ¡ˆ
            # ä½¿ç”¨ git diff æª¢æŸ¥ 'blog/' ç›®éŒ„æ˜¯å¦æœ‰è®Šå‹•
            if git diff --name-only "${LAST_COMMIT_SHA}" "${CURRENT_SHA}" -- 'blog/' | grep -q .; then
              # å¦‚æœ 'blog/' ç›®éŒ„æœ‰è®Šå‹•ï¼Œå‰‡æ¨™è¨˜ç‚ºéƒ¨è½æ ¼æ–‡ç« æ›´æ–°
              echo "IS_BLOG_POST=true" >> "$GITHUB_OUTPUT"
              # ç²å–å…·é«”æ–°å¢çš„éƒ¨è½æ ¼æª”æ¡ˆåˆ—è¡¨
              git diff --name-only --diff-filter=A "${LAST_COMMIT_SHA}" "${CURRENT_SHA}" -- 'blog/' -z | xargs -0 -r -n 1 echo >> temp_new_blog_files.txt
              BLOG_NEW_FILES=$(cat temp_new_blog_files.txt)
            else
              # å¦‚æœ 'blog/' ç›®éŒ„æ²’æœ‰è®Šå‹•ï¼Œå‰‡æ¨™è¨˜ç‚ºå…¶ä»–æäº¤ä¿®å¾©
              echo "IS_BLOG_POST=false" >> "$GITHUB_OUTPUT"
            fi
          fi
          
          # å°‡éƒ¨è½æ ¼æ–°å¢æª”æ¡ˆåˆ—è¡¨è¼¸å‡ºï¼Œä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
          echo "NEW_POST_FILES=${BLOG_NEW_FILES}" >> "$GITHUB_OUTPUT"

      - name: Process and send Telegram notification (Blog Post) # æ­¥é©Ÿ 3A: è™•ç†ä¸¦ç™¼é€éƒ¨è½æ ¼æ–‡ç«  Telegram é€šçŸ¥
        # åªæœ‰ç•¶ 'change-type' æ­¥é©Ÿåˆ¤æ–·ç‚ºéƒ¨è½æ ¼æ–‡ç« æ™‚æ‰åŸ·è¡Œ
        if: steps.change-type.outputs.IS_BLOG_POST == 'true' && steps.change-type.outputs.NEW_POST_FILES != ''
        run: |
          # å¾ GitHub Secrets ä¸­å–å¾— Telegram Bot Token å’Œ Chat ID
          TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          
          # å–å¾—ä¸Šä¸€å€‹æ­¥é©Ÿè¼¸å‡ºåµæ¸¬åˆ°çš„æ–°æ–‡ç« æª”æ¡ˆåˆ—è¡¨
          NEW_POST_FILES="${{ steps.change-type.outputs.NEW_POST_FILES }}"
          
          # ã€é‡è¦è¨­å®šã€‘æ‚¨çš„ç¶²ç«™åŸºç¤ç¶²å€
          # è«‹æ ¹æ“šæ‚¨çš„å¯¦éš›éƒ¨è½æ ¼ç¶²å€é€²è¡Œä¿®æ”¹
          BASE_URL="https://holybear.me"

          # å‡½å¼ï¼šå°å­—ä¸²é€²è¡Œ MarkdownV2 ç‰¹æ®Šå­—å…ƒè·³è„«
          escape_markdownv2() {
            local text="$1"
            text=$(echo "$text" | sed 's/\\/\\\\/g')
            text=$(echo "$text" | sed 's/\([_*\(\)~`>#\+\-=\|\{\}\.!]\)/\\\1/g')
            text=$(echo "$text" | sed 's/\./\\./g') 
            text=$(echo "$text" | sed 's/\[/\\[/g')
            text=$(echo "$text" | sed 's/\]/\\]/g')
            text=$(echo "$text" | sed 's/<support@github\.com>/\\<support@github\\.com\\>/g')
            echo "$text"
          }
          
          # éæ­·æ¯å€‹æ–°å¢çš„æª”æ¡ˆ
          for file_path in $NEW_POST_FILES; do
            echo "Processing file: $file_path"
            
            # è®€å–æª”æ¡ˆå…§å®¹
            file_content=$(cat "$file_path")
            
            # å¾ Markdown æª”æ¡ˆå…§å®¹ä¸­æå– title (å„ªå…ˆå¾ Front Matter æå–)
            TITLE=""
            TITLE=$(echo "$file_content" | awk '
              /^---$/ { count++; if (count == 2) exit; next }
              (count == 1 && /^\s*title:/) { 
                gsub(/^\s*title:\s*/, "", $0); 
                gsub(/\r/, "", $0);
                print $0; 
                exit
              }
            ')
            
            # å¦‚æœ Front Matter ä¸­æ²’æœ‰ titleï¼Œå‰‡å˜—è©¦å¾ H1 æ¨™é¡Œæå–
            if [ -z "$TITLE" ]; then
              TITLE=$(echo "$file_content" | grep -iE '^#\s*(.*)' | head -n 1 | sed -E 's/^#\s*(.*)/\1/' | tr -d '\r')
            fi

            # å¦‚æœä»ç„¶æ²’æœ‰æ¨™é¡Œï¼Œè¨­å®šç‚ºé è¨­å€¼
            if [ -z "$TITLE" ]; then
              TITLE="ç„¡æ¨™é¡Œæ–‡ç« "
            fi

            # æå– category
            CATEGORY=""
            CATEGORY=$(echo "$file_content" | grep -A 1 -E '^\s*category:' | grep -E '^\s*-\s*' | head -n 1 | sed -E 's/^\s*-\s*(.*)/\1/' | tr -d '\r')
            if [ -z "$CATEGORY" ]; then
              CATEGORY=$(echo "$file_content" | grep -iE '^\s*category:\s*\[.*\]' | head -n 1 | sed -E 's/^\s*category:\s*\[(.*)\].*/\1/' | cut -d',' -f1 | tr -d '\r')
            fi
            if [ -z "$CATEGORY" ]; then
              CATEGORY=$(echo "$file_content" | grep -iE '^\s*category:\s*[^\[-]' | head -n 1 | sed -E 's/^\s*category:\s*(.*)/\1/' | tr -d '\r')
            fi
            CATEGORY=$(echo "$CATEGORY" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')
            CATEGORY=$(echo "$CATEGORY" | sed -E 's/[\x27"\/]//g')

            # å¦‚æœæˆåŠŸæå–åˆ°é¡åˆ¥ï¼Œå‰‡å°‡æ¨™é¡ŒåŠ ä¸Šå‰ç¶´
            ESCAPED_TITLE=$(escape_markdownv2 "$TITLE")
            if [ -n "$CATEGORY" ]; then
              ESCAPED_CATEGORY=$(escape_markdownv2 "$CATEGORY")
              ESCAPED_TITLE="ã€${ESCAPED_CATEGORY}ã€‘${ESCAPED_TITLE}"
            fi
            
            # ç”¢ç”Ÿæ–‡ç« é€£çµçš„é‚è¼¯
            ARTICLE_SLUG=$(echo "$file_path" | sed -E 's|^blog/(.*)\.md$|\1|')
            ARTICLE_URL="${BASE_URL}/blog/${ARTICLE_SLUG}.html" 

            # è·³è„« commit è¨Šæ¯
            ESCAPED_COMMIT_MESSAGE=$(escape_markdownv2 "${{ github.event.head_commit.message }}")
            
            # è·³è„«ä½œè€…åç¨±
            ESCAPED_AUTHOR_NAME=$(escape_markdownv2 "${{ github.event.head_commit.author.name }}")

            # ç²å–æäº¤æ—¥æœŸä¸¦æ ¼å¼åŒ–
            COMMIT_DATE=$(date -d "${{ github.event.head_commit.timestamp }}" "+%Y-%m-%d %H:%M") # æ ¼å¼åŒ–ç‚º YYYY-MM-DD HH:MM
            ESCAPED_COMMIT_DATE=$(escape_markdownv2 "$COMMIT_DATE")

            # çµ„è£ Telegram è¨Šæ¯ (MarkdownV2 æ ¼å¼)
            MESSAGE="*ğŸ“¢ New push to GitHub*\n" # GitHub æ¨æ’­é€šçŸ¥ï¼Œç²—é«”
            MESSAGE+="*${ESCAPED_TITLE}*\n" # æ–‡ç« æ¨™é¡Œï¼Œç²—é«”
            MESSAGE+="\`\`\`${ESCAPED_COMMIT_MESSAGE}\`\`\`\n" # æäº¤è¨Šæ¯å…§å®¹ï¼Œç­‰å¯¬å­—é«”
            MESSAGE+="[\>\>é»æ­¤é–±è®€æ–‡ç« ](${ARTICLE_URL})\n" # æ–‡ç« é€£çµï¼Œ`>` ç¬¦è™Ÿè·³è„«
            MESSAGE+="${ESCAPED_COMMIT_DATE}\n" # å®Œæˆæ—¥æœŸ
            MESSAGE+="by \`${ESCAPED_AUTHOR_NAME}\`" # ä½œè€…åç¨±ï¼Œç­‰å¯¬å­—é«”

            # ç™¼é€ Telegram è¨Šæ¯
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{
                \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
                \"text\": \"$(echo "${MESSAGE}" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')\",
                \"parse_mode\": \"MarkdownV2\",
                \"disable_web_page_preview\": true
              }"
            echo "Telegram notification sent for $file_path with title: $TITLE"


      - name: Send Telegram notification (Other Changes) # æ­¥é©Ÿ 3B: ç™¼é€å…¶ä»–è®Šæ›´çš„ Telegram é€šçŸ¥
        # åªæœ‰ç•¶ 'change-type' æ­¥é©Ÿåˆ¤æ–·ç‚ºééƒ¨è½æ ¼æ–‡ç« æ›´æ–°æ™‚æ‰åŸ·è¡Œ
        if: steps.change-type.outputs.IS_BLOG_POST == 'false'
        run: |
          # å¾ GitHub Secrets ä¸­å–å¾— Telegram Bot Token å’Œ Chat ID
          TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          
          # ç²å–æäº¤è¨Šæ¯å’Œä½œè€…åç¨±
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          AUTHOR_NAME="${{ github.event.head_commit.author.name }}"

          # å‡½å¼ï¼šå°å­—ä¸²é€²è¡Œ MarkdownV2 ç‰¹æ®Šå­—å…ƒè·³è„«
          escape_markdownv2() {
            local text="$1"
            text=$(echo "$text" | sed 's/\\/\\\\/g')
            text=$(echo "$text" | sed 's/\([_*\(\)~`>#\+\-=\|\{\}\.!]\)/\\\1/g')
            text=$(echo "$text" | sed 's/\./\\./g') 
            text=$(echo "$text" | sed 's/\[/\\[/g')
            text=$(echo "$text" | sed 's/\]/\\]/g')
            text=$(echo "$text" | sed 's/<support@github\.com>/\\<support@github\\.com\\>/g')
            echo "$text"
          }

          # åˆ¤æ–·æ˜¯å¦é¡¯ç¤º "å„ªåŒ–åƒæ•¸"
          DISPLAY_MESSAGE=""
          if [ -z "$COMMIT_MESSAGE" ]; then
            DISPLAY_MESSAGE="å„ªåŒ–åƒæ•¸"
          else
            DISPLAY_MESSAGE="$COMMIT_MESSAGE"
          fi

          # è·³è„«æäº¤è¨Šæ¯å’Œä½œè€…åç¨±
          ESCAPED_DISPLAY_MESSAGE=$(escape_markdownv2 "$DISPLAY_MESSAGE")
          ESCAPED_AUTHOR_NAME=$(escape_markdownv2 "$AUTHOR_NAME")

          # ç²å–æäº¤æ—¥æœŸä¸¦æ ¼å¼åŒ–
          COMMIT_DATE=$(date -d "${{ github.event.head_commit.timestamp }}" "+%Y-%m-%d %H:%M") # æ ¼å¼åŒ–ç‚º YYYY-MM-DD HH:MM
          ESCAPED_COMMIT_DATE=$(escape_markdownv2 "$COMMIT_DATE")

          # çµ„è£ Telegram è¨Šæ¯ (MarkdownV2 æ ¼å¼)
          MESSAGE="*ğŸ› ï¸ æ–°çš„æäº¤ä¿®å¾©*\n" # æ–°çš„æäº¤ä¿®å¾©ï¼Œç²—é«”
          MESSAGE+="\`\`\`${ESCAPED_DISPLAY_MESSAGE}\`\`\`\n" # æäº¤è¨Šæ¯å…§å®¹ï¼Œç­‰å¯¬å­—é«”
          MESSAGE+="${ESCAPED_COMMIT_DATE}\n" # å®Œæˆæ—¥æœŸ
          MESSAGE+="by \`${ESCAPED_AUTHOR_NAME}\`" # ä½œè€…åç¨±ï¼Œç­‰å¯¬å­—é«”

          # ç™¼é€ Telegram è¨Šæ¯
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"$(echo "${MESSAGE}" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')\",
              \"parse_mode\": \"MarkdownV2\",
              \"disable_web_page_preview\": true
            }"
          echo "Telegram notification sent for other changes."
