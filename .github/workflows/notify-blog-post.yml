name: Notify New Blog Post to Telegram # å·¥ä½œæµç¨‹åç¨±

# ç•¶æœ‰æ–°çš„ push äº‹ä»¶ç™¼ç”Ÿæ™‚è§¸ç™¼æ­¤ workflow
on:
  push:
    branches:
      - main # è«‹å°‡æ­¤è™•æ”¹ç‚ºæ‚¨å„²å­˜åº«çš„ä¸»è¦åˆ†æ”¯åç¨±ï¼Œä¾‹å¦‚ master
    paths:
      - 'blog/**' # ç›£è½ 'blog/' ç›®éŒ„ä¸‹çš„ä»»ä½•æª”æ¡ˆè®Šå‹•
      - 'blog/**/*' # ç¢ºä¿æ¶µè“‹ 'blog/' å­ç›®éŒ„ä¸­çš„è®Šå‹•

jobs:
  notify_new_post:
    runs-on: ubuntu-latest # åœ¨ Ubuntu ç³»çµ±ä¸ŠåŸ·è¡Œé€™å€‹ job

    steps:
      - name: Checkout repository # æ­¥é©Ÿ 1: æª¢å‡ºæ‚¨çš„å„²å­˜åº«ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          # ç²å–æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Œä»¥ä¾¿ git diff èƒ½æ­£ç¢ºåˆ¤æ–·ã€Œæ–°å¢ã€çš„æª”æ¡ˆ
          fetch-depth: 0

      - name: Get new files in target directory # æ­¥é©Ÿ 2: å–å¾—æœ¬æ¬¡ push ä¸­æœ‰å“ªäº›æª”æ¡ˆæ˜¯æ–°ã€Œå¢ã€çš„
        id: new-files # çµ¦é€™å€‹æ­¥é©Ÿä¸€å€‹ IDï¼Œä»¥ä¾¿å¾ŒçºŒå¼•ç”¨å…¶è¼¸å‡º
        run: |
          TARGET_DIR="blog/" # è¨­å®šæ‚¨è¦ç›£æ§çš„ç›®éŒ„

          # ç²å–æœ¬æ¬¡ push å¸¶å…¥çš„ commit SHA
          CURRENT_SHA="${{ github.sha }}"
          # ç²å–æœ¬æ¬¡ push ä¹‹å‰ä¸€å€‹ commit çš„ SHAã€‚å¦‚æœé€™æ˜¯ç¬¬ä¸€å€‹ commitï¼Œå‰‡æœƒæ˜¯ç©ºå­—ä¸²ã€‚
          LAST_COMMIT_SHA=$(git rev-parse "${CURRENT_SHA}~1" 2>/dev/null || echo "")

          DETECTED_FILES=""
          if [ -z "$LAST_COMMIT_SHA" ]; then
            # å°æ–¼å„²å­˜åº«çš„ç¬¬ä¸€æ¬¡ pushï¼Œæ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„æ–‡ä»¶éƒ½è¦–ç‚ºã€Œæ–°å¢ã€
            # ç¢ºä¿ find æŒ‡ä»¤èƒ½è™•ç†è·¯å¾‘ä¸­çš„ç©ºç™½å­—å…ƒ
            find "$TARGET_DIR" -type f -print0 | xargs -0 -r -n 1 echo >> temp_new_files.txt
            DETECTED_FILES=$(cat temp_new_files.txt)
          else
            # æ¯”è¼ƒæœ¬æ¬¡ push å’Œä¸Šä¸€å€‹ commit ä¹‹é–“çš„å·®ç•°ï¼Œåªç¯©é¸æ–°å¢çš„æª”æ¡ˆ
            # ä½¿ç”¨ -z å’Œ xargs -0 ä¾†å®‰å…¨è™•ç†æª”åä¸­çš„ç©ºç™½
            git diff --name-only --diff-filter=A "${LAST_COMMIT_SHA}" "${CURRENT_SHA}" -- "$TARGET_DIR" -z | xargs -0 -r -n 1 echo >> temp_new_files.txt
            DETECTED_FILES=$(cat temp_new_files.txt)
          fi

          NEW_POST_FILES=""
          for file in $DETECTED_FILES; do
            # å†æ¬¡ç¢ºèªæª”æ¡ˆæ˜¯åœ¨ç›®æ¨™ç›®éŒ„ä¸‹ (é¿å…æ„å¤–åµæ¸¬åˆ°å…¶ä»–è·¯å¾‘çš„åŒåæª”æ¡ˆ)
            if [[ "$file" == "$TARGET_DIR"* ]]; then
              NEW_POST_FILES="$NEW_POST_FILES $file"
            fi
          done

          echo "Detected NEW files in ${TARGET_DIR} directory: $NEW_POST_FILES"
          # å°‡çµæœè¼¸å‡ºçµ¦ä¸‹ä¸€å€‹æ­¥é©Ÿ
          echo "NEW_POST_FILES=${NEW_POST_FILES}" >> "$GITHUB_OUTPUT"

      - name: Process and send Telegram notification # è™•ç†æª”æ¡ˆä¸¦ç™¼é€ Telegram é€šçŸ¥
        # åªæœ‰ç•¶ 'Get new files' æ­¥é©Ÿæœ‰åµæ¸¬åˆ°æ–°çš„æ–‡ç« æª”æ¡ˆæ™‚æ‰åŸ·è¡Œ
        if: steps.new-files.outputs.NEW_POST_FILES != ''
        run: |
          # å¾ GitHub Secrets ä¸­å–å¾— Telegram Bot Token å’Œ Chat ID
          TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          
          # å–å¾—ä¸Šä¸€å€‹æ­¥é©Ÿè¼¸å‡ºåµæ¸¬åˆ°çš„æ–°æ–‡ç« æª”æ¡ˆåˆ—è¡¨
          NEW_POST_FILES="${{ steps.new-files.outputs.NEW_POST_FILES }}"
          
          # ã€é‡è¦è¨­å®šã€‘æ‚¨çš„ç¶²ç«™åŸºç¤ç¶²å€
          # è«‹æ ¹æ“šæ‚¨çš„å¯¦éš›éƒ¨è½æ ¼ç¶²å€é€²è¡Œä¿®æ”¹
          BASE_URL="https://holybear.me"

          # å‡½å¼ï¼šå°å­—ä¸²é€²è¡Œ MarkdownV2 ç‰¹æ®Šå­—å…ƒè·³è„«
          # å®˜æ–¹å®Œæ•´åˆ—è¡¨ï¼š_ * [ ] ( ) ~ ` > # + - = | { } . !
          escape_markdownv2() {
            local text="$1"
            # å„ªå…ˆè™•ç†åæ–œç·šæœ¬èº«ï¼Œä»¥å…å½±éŸ¿å¾ŒçºŒè·³è„«
            text=$(echo "$text" | sed 's/\\/\\\\/g')
            # è·³è„« MarkdownV2 çš„ä¿ç•™å­—å…ƒï¼Œä½†æ’é™¤é‚£äº›ä½œç‚ºèªæ³•ä¸€éƒ¨åˆ†çš„ï¼ˆä¾‹å¦‚é€£çµå…§éƒ¨çš„ []()ã€ç²—é«”*ç­‰ï¼‰
            # é€™éœ€è¦æ›´ç²¾ç¢ºçš„æ›¿æ›é‚è¼¯ï¼Œä»¥é¿å…ç ´å£ Markdown èªæ³•
            # ä¾‹å¦‚ï¼šå°æ–¼ []()ï¼Œæˆ‘å€‘ä¸æ‡‰è©²è·³è„«è£¡é¢çš„ [ å’Œ ]
            # æœ€å¥½çš„æ–¹æ³•æ˜¯å…ˆè™•ç†ç‰¹æ®Šå­—å…ƒï¼Œå†æ’å…¥ Markdown èªæ³•
            # æˆ–è€…ï¼Œæ›´ç°¡å–®åœ°ï¼Œåƒ…è·³è„«é‚£äº›ä¸åœ¨ç‰¹å®šèªæ³•ä¸­çš„å­—å…ƒã€‚
            
            # ç”±æ–¼ Bash sed è™•ç†è¤‡é›œçš„æ­£å‰‡è¡¨é”å¼æœ‰å…¶é™åˆ¶ï¼Œ
            # é€™è£¡æ¡ç”¨è¼ƒç‚ºä¿å®ˆçš„è·³è„«ç­–ç•¥ï¼Œå¯èƒ½æœƒè·³è„«æ‰é€£çµæ–‡å­—è£¡çš„æŸäº›å­—å…ƒ
            # ä½†ç¢ºä¿å…¶ä»–éèªæ³•ç¬¦è™Ÿè¢«è·³è„«
            # å®˜æ–¹åˆ—è¡¨ä¸­çš„æ‰€æœ‰å­—å…ƒéƒ½é è¨­è·³è„«ï¼Œå¾Œé¢å†ç‰¹æ®Šè™•ç†
            text=$(echo "$text" | sed 's/\([_*\(\)~`>#\+\-=\|\{\}\.!]\)/\\\1/g')
            
            # å°æ–¼é» '.'ï¼Œåƒ…åœ¨éç¶²å€å”è­°éƒ¨åˆ†è·³è„«
            # é€™æ˜¯ä¸€å€‹è¤‡é›œçš„æ­£è¦è¡¨é”å¼ï¼Œå¯èƒ½éœ€è¦è¦–æƒ…æ³èª¿æ•´
            # ç°¡å–®è™•ç†æ‰€æœ‰é»ï¼Œå¯èƒ½å°è‡´ç¶²å€ä¸­çš„é»è¢«è·³è„«ï¼Œä½†Telegramé€šå¸¸èƒ½è™•ç†
            # ç‚ºäº†é¿å…è¤‡é›œåº¦ï¼Œé€™è£¡ç›´æ¥è·³è„«ï¼Œå¦‚æœç¶²å€ç„¡æ³•é»æ“Šï¼Œå†å›ä¾†èª¿æ•´ã€‚
            text=$(echo "$text" | sed 's/\./\\./g') 
            
            # é‡å° [ ]ï¼Œå¦‚æœå®ƒå€‘ä¸æ˜¯é€£çµèªæ³•çš„ä¸€éƒ¨åˆ†ï¼Œæ‰è·³è„«
            # ç”±æ–¼é€™è£¡æ˜¯åœ¨é€šç”¨è·³è„«å‡½å¼ä¸­ï¼Œå¾ˆé›£åˆ¤æ–·æ˜¯å¦ç‚ºé€£çµèªæ³•ã€‚
            # å¦‚æœ `[bot]` é€™ç¨®å‡ºç¾å•é¡Œï¼Œå°±éœ€è¦ç¢ºä¿å®ƒå€‘è¢«è·³è„«ã€‚
            # é€™è£¡ç¢ºä¿æ‰€æœ‰ `[` å’Œ `]` éƒ½è¢«è·³è„«
            text=$(echo "$text" | sed 's/\[/\\[/g')
            text=$(echo "$text" | sed 's/\]/\\]/g')
            
            # ç‰¹åˆ¥è™•ç† `Signed-off-by: dependabot[bot] <support@github.com> by dependabot[bot]` é€™è¡Œ
            # ç¢ºä¿ [bot] å’Œ <support@github.com> è£¡çš„ < > è¢«æ­£ç¢ºè·³è„«
            text=$(echo "$text" | sed 's/<support@github\.com>/\\<support@github\\.com\\>/g')

            echo "$text"
          }
          
          # éæ­·æ¯å€‹æ–°å¢çš„æª”æ¡ˆ
          for file_path in $NEW_POST_FILES; do
            echo "Processing file: $file_path"
            
            # è®€å–æª”æ¡ˆå…§å®¹
            file_content=$(cat "$file_path")
            
            # å¾ Markdown æª”æ¡ˆå…§å®¹ä¸­æå– title (å„ªå…ˆå¾ Front Matter æå–)
            TITLE=""
            TITLE=$(echo "$file_content" | awk '
              /^---$/ { count++; if (count == 2) exit; next }
              (count == 1 && /^\s*title:/) { 
                gsub(/^\s*title:\s*/, "", $0); 
                gsub(/\r/, "", $0);
                print $0; 
                exit
              }
            ')
            
            # å¦‚æœ Front Matter ä¸­æ²’æœ‰ titleï¼Œå‰‡å˜—è©¦å¾ H1 æ¨™é¡Œæå–
            if [ -z "$TITLE" ]; then
              TITLE=$(echo "$file_content" | grep -iE '^#\s*(.*)' | head -n 1 | sed -E 's/^#\s*(.*)/\1/' | tr -d '\r')
            fi

            # å¦‚æœä»ç„¶æ²’æœ‰æ¨™é¡Œï¼Œè¨­å®šç‚ºé è¨­å€¼
            if [ -z "$TITLE" ]; then
              TITLE="ç„¡æ¨™é¡Œæ–‡ç« "
            fi

            # æå– category
            CATEGORY=""
            CATEGORY=$(echo "$file_content" | grep -A 1 -E '^\s*category:' | grep -E '^\s*-\s*' | head -n 1 | sed -E 's/^\s*-\s*(.*)/\1/' | tr -d '\r')
            if [ -z "$CATEGORY" ]; then
              CATEGORY=$(echo "$file_content" | grep -iE '^\s*category:\s*\[.*\]' | head -n 1 | sed -E 's/^\s*category:\s*\[(.*)\].*/\1/' | cut -d',' -f1 | tr -d '\r')
            fi
            if [ -z "$CATEGORY" ]; then
              CATEGORY=$(echo "$file_content" | grep -iE '^\s*category:\s*[^\[-]' | head -n 1 | sed -E 's/^\s*category:\s*(.*)/\1/' | tr -d '\r')
            fi
            CATEGORY=$(echo "$CATEGORY" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')
            CATEGORY=$(echo "$CATEGORY" | sed -E 's/[\x27"\/]//g')

            # å¦‚æœæˆåŠŸæå–åˆ°é¡åˆ¥ï¼Œå‰‡å°‡æ¨™é¡ŒåŠ ä¸Šå‰ç¶´
            # é€™è£¡ TITLE æœ¬èº«è¦å…ˆè·³è„«ï¼Œç„¶å¾Œå†çµ„è£
            ESCAPED_TITLE=$(escape_markdownv2 "$TITLE")
            if [ -n "$CATEGORY" ]; then
              ESCAPED_CATEGORY=$(escape_markdownv2 "$CATEGORY")
              ESCAPED_TITLE="ã€${ESCAPED_CATEGORY}ã€‘${ESCAPED_TITLE}" # ä¸éœ€è¦è·³è„« ã€ã€‘ å› ç‚ºå®ƒä¸æ˜¯MarkdownV2ä¿ç•™å­—å…ƒ
            fi
            
            # ç”¢ç”Ÿæ–‡ç« é€£çµçš„é‚è¼¯
            ARTICLE_SLUG=$(echo "$file_path" | sed -E 's|^blog/(.*)\.md$|\1|')
            # ç¶²å€æœ¬èº«ä¸éœ€è¦è·³è„«ï¼Œå› ç‚ºå®ƒåœ¨é€£çµèªæ³•çš„æ‹¬è™Ÿå…§éƒ¨
            ARTICLE_URL="${BASE_URL}/blog/${ARTICLE_SLUG}.html" 

            # è·³è„« commit è¨Šæ¯
            ESCAPED_COMMIT_MESSAGE=$(escape_markdownv2 "${{ github.event.head_commit.message }}")
            
            # è·³è„«ä½œè€…åç¨±
            ESCAPED_AUTHOR_NAME=$(escape_markdownv2 "${{ github.event.head_commit.author.name }}")

            # çµ„è£ Telegram è¨Šæ¯ (MarkdownV2 æ ¼å¼)
        
            MESSAGE="*ğŸ“¢ New push to GitHub*\n" # GitHub æ¨æ’­é€šçŸ¥ï¼Œç²—é«”
            MESSAGE+="*${ESCAPED_TITLE}*\n" # æ–‡ç« æ¨™é¡Œï¼Œç²—é«”
            MESSAGE+="\`\`\`${ESCAPED_COMMIT_MESSAGE}\`\`\`\n" # æäº¤è¨Šæ¯å…§å®¹ï¼Œç­‰å¯¬å­—é«”
            MESSAGE+="[\>\>é»æ­¤é–±è®€æ–‡ç« ](${ARTICLE_URL})\n" # æ–‡ç« é€£çµï¼Œ`>` ç¬¦è™Ÿè·³è„«
            MESSAGE+="by \`${ESCAPED_AUTHOR_NAME}\`" # ä½œè€…åç¨±ï¼Œç­‰å¯¬å­—é«”

            # ç™¼é€ Telegram è¨Šæ¯
            # å°‡è¨Šæ¯å…§å®¹å‚³éçµ¦ curlï¼Œä¸¦æŒ‡å®š parse_mode ç‚º MarkdownV2 å’Œ disable_web_page_preview
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{
                \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
                \"text\": \"$(echo "${MESSAGE}" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')\",
                \"parse_mode\": \"MarkdownV2\",
                \"disable_web_page_preview\": true
              }"
            echo "Telegram notification sent for $file_path with title: $TITLE"
          done
