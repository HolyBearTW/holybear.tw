name: Notify New Blog Post to Telegram # å·¥ä½œæµç¨‹åç¨±

# ç•¶æœ‰æ–°çš„ push äº‹ä»¶ç™¼ç”Ÿæ™‚è§¸ç™¼æ­¤ workflow
on:
  push:
    branches:
      - main # ç›£æ§ main åˆ†æ”¯
    paths:
      - 'blog/**' # ç›£æ§ 'blog/' ç›®éŒ„ä¸‹çš„ä»»ä½•æª”æ¡ˆè®Šå‹•

jobs:
  notify_new_post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ç²å–æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Œä»¥ä¾¿ git diff èƒ½æ­£ç¢ºåˆ¤æ–·

      - name: Get new files in target directory
        id: get-new-files
        run: |
          TARGET_DIR="blog/"
          # ä½¿ç”¨ git diff å®‰å…¨åœ°æ‰¾å‡ºæ‰€æœ‰æœ¬æ¬¡ commit æ–°å¢çš„ .md æª”æ¡ˆ (A=Added)
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- "$TARGET_DIR" | grep '\.md$')
          
          # å°‡æ‰¾åˆ°çš„æª”æ¡ˆåˆ—è¡¨ï¼ˆå¯èƒ½æœ‰å¤šè¡Œï¼‰è¨­å®šç‚º GitHub Actions çš„è¼¸å‡º
          echo "new_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "${NEW_FILES}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Process and send Telegram notification
        # åªæœ‰ç•¶ä¸Šä¸€æ­¥é©Ÿ 'get-new-files' æœ‰æ‰¾åˆ°æª”æ¡ˆæ™‚æ‰åŸ·è¡Œ
        if: steps.get-new-files.outputs.new_files != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          NEW_POST_FILES: ${{ steps.get-new-files.outputs.new_files }}
        run: |
          # ã€é‡è¦è¨­å®šã€‘æ‚¨çš„ç¶²ç«™åŸºç¤ç¶²å€
          BASE_URL="https://holybear.me"

          # å‡½å¼ï¼šå°å­—ä¸²é€²è¡Œ MarkdownV2 ç‰¹æ®Šå­—å…ƒè·³è„«
          escape_markdownv2() {
            local text="$1"
            echo "$text" | sed 's/\([_*\[\]()~`>#+\-=|{}.!]\)/\\\1/g'
          }

          # ä½¿ç”¨ while read è¿´åœˆå®‰å…¨åœ°è™•ç†æ¯ä¸€å€‹æª”æ¡ˆè·¯å¾‘
          echo "${NEW_POST_FILES}" | while IFS= read -r file_path; do
            if [ -z "$file_path" ]; then
              continue
            fi
            
            echo "Processing file: $file_path"

            file_content=$(tr -d '\r' < "$file_path")
            
            TITLE=$(echo "$file_content" | awk -F': ' '/^title:/ {print $2; exit}')
            if [ -z "$TITLE" ]; then
              TITLE=$(echo "$file_content" | awk -F'# ' '/^# / {print $2; exit}')
            fi
            if [ -z "$TITLE" ]; then
              TITLE="ç„¡æ¨™é¡Œæ–‡ç« "
            fi

            ESCAPED_TITLE=$(escape_markdownv2 "$TITLE")
            
            ARTICLE_SLUG=$(echo "$file_path" | sed -E 's|^blog/(.*)\.md$|\1|')
            ARTICLE_URL="${BASE_URL}/${ARTICLE_SLUG}"
            
            COMMIT_MESSAGE=$(git log -1 --pretty=%B)
            ESCAPED_COMMIT_MESSAGE=$(escape_markdownv2 "$COMMIT_MESSAGE")
            AUTHOR_NAME=$(git log -1 --pretty=%an)
            ESCAPED_AUTHOR_NAME=$(escape_markdownv2 "$AUTHOR_NAME")
            
            MESSAGE="*ğŸ“¢ New push to GitHub*\n\n"
            MESSAGE+="*${ESCAPED_TITLE}*\n\n"
            MESSAGE+="\`\`\`\n${ESCAPED_COMMIT_MESSAGE}\n\`\`\`\n"
            MESSAGE+="[â¡ï¸ é»æ­¤é–±è®€æ–‡ç« ](${ARTICLE_URL})\n\n"
            MESSAGE+="by \`${ESCAPED_AUTHOR_NAME}\`"

            # â–¼â–¼â–¼ å·²ä¿®æ­£æ­¤è™•çš„ç¶²å€æ ¼å¼ â–¼â–¼â–¼
            RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
              --data-urlencode "text=${MESSAGE}" \
              --data-urlencode "parse_mode=MarkdownV2" \
              --data-urlencode "disable_web_page_preview=true")

            if echo "$RESPONSE" | grep -q '"ok":true'; then
              echo "âœ… Telegram notification sent successfully for: $file_path"
            else
              echo "âŒ Failed to send Telegram notification for: $file_path"
              echo "Telegram API Response: $RESPONSE"
            fi
          done
