name: Deploy Blog & Notify New Post to Telegram # å·¥ä½œæµç¨‹åç¨±ï¼Œæ›´åç‚ºéƒ¨ç½²èˆ‡é€šçŸ¥

on:
  push:
    branches:
      - main # è«‹å°‡æ­¤è™•æ”¹ç‚ºæ‚¨å„²å­˜åº«çš„ä¸»è¦åˆ†æ”¯åç¨±ï¼Œä¾‹å¦‚ master
    paths:
      - 'blog/**' # ç›£è½ 'blog/' ç›®éŒ„ä¸‹çš„ä»»ä½•æª”æ¡ˆè®Šå‹•
      - 'blog/**/*' # ç¢ºä¿æ¶µè“‹ 'blog/' å­ç›®éŒ„ä¸­çš„è®Šå‹•

jobs:
  # --- ç¬¬ä¸€å€‹ Job: å»ºç½®éƒ¨è½æ ¼ä¸¦éƒ¨ç½²åˆ° GitHub Pages ---
  build_and_deploy:
    runs-on: ubuntu-latest
    # è¨­å®šæ¬Šé™ï¼Œä»¥ä¾¿å¯ä»¥éƒ¨ç½² Pages
    permissions:
      contents: read
      pages: write
      id-token: write # éƒ¨ç½² Pages éœ€è¦é€™å€‹æ¬Šé™

    outputs: # å®šç¾©é€™å€‹ Job æœƒè¼¸å‡ºçš„è®Šæ•¸ï¼Œä¾›å¾ŒçºŒ Job ä½¿ç”¨
      new_post_files: ${{ steps.get-new-files.outputs.NEW_POST_FILES }} # å°‡åµæ¸¬åˆ°çš„æ–°æª”æ¡ˆåˆ—è¡¨è¼¸å‡º
      # å‡è¨­æ‚¨æƒ³å°‡ TITLE å’Œ ARTICLE_URL ä¹Ÿå‚³éçµ¦ä¸‹ä¸€å€‹ Jobï¼Œ
      # ä½†å› ç‚ºæœ‰å¤šå€‹æª”æ¡ˆï¼Œé€™è£¡æœƒéœ€è¦æ›´è¤‡é›œçš„è™•ç†ï¼Œä¾‹å¦‚æ‰“åŒ…æˆ JSON æˆ–åªå‚³éç¬¬ä¸€å€‹
      # ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å¯ä»¥åœ¨é€šçŸ¥ Job ä¸­å†æ¬¡è™•ç†æª”æ¡ˆï¼Œæˆ–è€…åªé€šçŸ¥ç¬¬ä¸€å€‹æ–°æª”æ¡ˆ
      # é€™è£¡æˆ‘å€‘åªå‚³é new_post_filesï¼Œè®“é€šçŸ¥ Job å†å»è®€å–æª”æ¡ˆå…§å®¹

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ç²å–æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Œä»¥ä¾¿ git diff èƒ½æ­£ç¢ºåˆ¤æ–·ã€Œæ–°å¢ã€çš„æª”æ¡ˆ

      - name: Get new files in target directory
        id: get-new-files # ä¿ç•™åŸä¾†çš„ IDï¼Œæ–¹ä¾¿å¼•ç”¨
        run: |
          TARGET_DIR="blog/" # è¨­å®šæ‚¨è¦ç›£æ§çš„ç›®éŒ„
          CURRENT_SHA="${{ github.sha }}"
          LAST_COMMIT_SHA=$(git rev-parse "${CURRENT_SHA}~1" 2>/dev/null || echo "")

          DETECTED_FILES=""
          if [ -z "$LAST_COMMIT_SHA" ]; then
            find "$TARGET_DIR" -type f -print0 | xargs -0 -r -n 1 echo >> temp_new_files.txt
            DETECTED_FILES=$(cat temp_new_files.txt)
          else
            git diff --name-only --diff-filter=A "${LAST_COMMIT_SHA}" "${CURRENT_SHA}" -- "$TARGET_DIR" -z | xargs -0 -r -n 1 echo >> temp_new_files.txt
            DETECTED_FILES=$(cat temp_new_files.txt)
          fi

          NEW_POST_FILES=""
          for file in $DETECTED_FILES; do
            if [[ "$file" == "$TARGET_DIR"* ]]; then
              NEW_POST_FILES="$NEW_POST_FILES $file"
            fi
          done

          echo "Detected NEW files in ${TARGET_DIR} directory: $NEW_POST_FILES"
          echo "NEW_POST_FILES=${NEW_POST_FILES}" >> "$GITHUB_OUTPUT"

      # --- ã€æ–°å¢æ­¥é©Ÿã€‘å»ºç½®æ‚¨çš„éƒ¨è½æ ¼ ---
      # é€™è£¡éœ€è¦æ›¿æ›æˆæ‚¨å¯¦éš›å»ºç½®éƒ¨è½æ ¼çš„æŒ‡ä»¤
      # ç¯„ä¾‹ï¼šå¦‚æœæ‚¨ä½¿ç”¨ Jekyllï¼Œå¯èƒ½æœƒæœ‰ bundle exec jekyll build
      - name: Build Blog
        run: |
          # å‡è¨­æ‚¨çš„éƒ¨è½æ ¼å»ºç½®æŒ‡ä»¤æœƒå°‡éœæ…‹æª”æ¡ˆè¼¸å‡ºåˆ° _site ç›®éŒ„
          echo "Building your blog..."
          # ä¾‹å¦‚ï¼šbundle exec jekyll build
          # é€™è£¡æˆ‘å€‘å‡è¨­æœƒæœ‰ä¸€å€‹ _site ç›®éŒ„ç”Ÿæˆ
          mkdir -p _site
          # æ¨¡æ“¬ç”¢ç”Ÿä¸€äº›æª”æ¡ˆï¼Œé€™äº›æª”æ¡ˆæœƒåœ¨ Pages éƒ¨ç½²
          echo "<h1>Hello from GitHub Pages!</h1><p>é€™æ˜¯ç´¢å¼•é </p>" > _site/index.html
          echo "<h1>æ–°æ–‡ç« </h1>" > _site/blog/new-article.html # æ¨¡æ“¬æ‚¨çš„æ–‡ç« å…§å®¹

      # --- GitHub Pages éƒ¨ç½²ç›¸é—œæ­¥é©Ÿ ---
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact for deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site' # é€™è£¡æ‡‰æŒ‡å‘æ‚¨éƒ¨è½æ ¼çš„éœæ…‹æª”æ¡ˆè¼¸å‡ºç›®éŒ„

      - name: Deploy to GitHub Pages
        id: deployment # çµ¦é€™å€‹æ­¥é©Ÿä¸€å€‹ IDï¼Œæ–¹ä¾¿å¾ŒçºŒå¼•ç”¨
        uses: actions/deploy-pages@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨å…§å»ºçš„ token

  # --- ç¬¬äºŒå€‹ Job: ç™¼é€ Telegram é€šçŸ¥ (åœ¨ Pages éƒ¨ç½²æˆåŠŸå¾Œ) ---
  notify_on_deploy:
    runs-on: ubuntu-latest
    needs: build_and_deploy # é€™å€‹ Job ä¾è³´ build_and_deploy Jobï¼Œæœƒç­‰å®ƒæˆåŠŸå¾Œæ‰åŸ·è¡Œ

    # åªæœ‰ç•¶ build_and_deploy æˆåŠŸå®Œæˆï¼Œä¸¦ä¸”åµæ¸¬åˆ°æ–°çš„æ–‡ç« æª”æ¡ˆæ™‚æ‰åŸ·è¡Œé€šçŸ¥
    if: success() && needs.build_and_deploy.outputs.new_post_files != ''

    steps:
      - name: Checkout repository for notification # é‡æ–°æª¢å‡ºç¨‹å¼ç¢¼ï¼Œä»¥ä¾¿è®€å–æ–‡ç« å…§å®¹
        uses: actions/checkout@v4

      - name: Send Telegram notification
        run: |
          TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"

          # å¾ä¸Šä¸€å€‹ Job ç²å–åµæ¸¬åˆ°çš„æ–°æ–‡ç« æª”æ¡ˆåˆ—è¡¨
          NEW_POST_FILES="${{ needs.build_and_deploy.outputs.new_post_files }}"
          
          # ã€é‡è¦è¨­å®šã€‘æ‚¨çš„ç¶²ç«™åŸºç¤ç¶²å€
          BASE_URL="https://holybear.me"

          # éæ­·æ¯å€‹æ–°å¢çš„æª”æ¡ˆ
          for file_path in $NEW_POST_FILES; do
            echo "Processing file: $file_path"
            
            file_content=$(cat "$file_path")
            
            # å¾ Markdown æª”æ¡ˆå…§å®¹ä¸­æå– title
            TITLE=""
            TITLE=$(echo "$file_content" | awk '
              /^---$/ { count++; if (count == 2) exit; next }
              (count == 1 && /^\s*title:/) { 
                gsub(/^\s*title:\s*/, "", $0); 
                gsub(/\r/, "", $0);
                print $0; 
                exit
              }
            ')
            
            if [ -z "$TITLE" ]; then
              TITLE=$(echo "$file_content" | grep -iE '^#\s*(.*)' | head -n 1 | sed -E 's/^#\s*(.*)/\1/' | tr -d '\r')
            fi
            if [ -z "$TITLE" ]; then
              TITLE="ç„¡æ¨™é¡Œæ–‡ç« "
            fi

            # æå– category (æ²¿ç”¨æ‚¨çš„é‚è¼¯)
            CATEGORY=""
            CATEGORY=$(echo "$file_content" | grep -A 1 -E '^\s*category:' | grep -E '^\s*-\s*' | head -n 1 | sed -E 's/^\s*-\s*(.*)/\1/' | tr -d '\r')
            if [ -z "$CATEGORY" ]; then
              CATEGORY=$(echo "$file_content" | grep -iE '^\s*category:\s*\[.*\]' | head -n 1 | sed -E 's/^\s*category:\s*\[(.*)\].*/\1/' | cut -d',' -f1 | tr -d '\r')
            fi
            if [ -z "$CATEGORY" ]; then
              CATEGORY=$(echo "$file_content" | grep -iE '^\s*category:\s*[^\[-]' | head -n 1 | sed -E 's/^\s*category:\s*(.*)/\1/' | tr -d '\r')
            fi
            CATEGORY=$(echo "$CATEGORY" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')
            CATEGORY=$(echo "$CATEGORY" | sed -E 's/[\x27"\/]//g')

            if [ -n "$CATEGORY" ]; then
                TITLE="ã€${CATEGORY}ã€‘${TITLE}"
            fi

            # ç”¢ç”Ÿæ–‡ç« é€£çµçš„é‚è¼¯ (é€™éƒ¨åˆ†éœ€è¦æ ¹æ“šæ‚¨çš„éƒ¨è½æ ¼ç³»çµ±å¯¦éš›ç”Ÿæˆ URL çš„æ–¹å¼ä¾†èª¿æ•´)
            # å› ç‚º Pages éƒ¨ç½²å¾Œï¼Œæ‚¨é€šå¸¸æœƒåœ¨ _site/blog/ ç”¢ç”Ÿ HTML æª”æ¡ˆ
            # æ‰€ä»¥ ARTICLE_SLUG æ‡‰è©²æ˜¯ 'blog/my-article'ï¼Œæœ€çµ‚ URL å¯èƒ½æ˜¯ https://holybear.me/blog/my-article.html
            # é€™è£¡éœ€è¦æ³¨æ„æ‚¨çš„éƒ¨è½æ ¼ç³»çµ±ç”Ÿæˆ URL çš„æœ€çµ‚å½¢å¼æ˜¯ .html é‚„æ˜¯ /
            ARTICLE_SLUG=$(echo "$file_path" | sed -E 's|^blog/(.*)\.md$|\1|')
            ARTICLE_URL="${BASE_URL}/blog/${ARTICLE_SLUG}.html" # å‡è¨­æ‚¨çš„æ–‡ç« æ˜¯ .html çµå°¾

            # çµ„è£ Telegram è¨Šæ¯
            MESSAGE="**ğŸ“¢ New push to GitHub**\n"
            MESSAGE+="**${TITLE}**\n"
            MESSAGE+="```${{ github.event.head_commit.message }}```\n" # ä½¿ç”¨æ‚¨çš„å–®è¡Œç¨‹å¼ç¢¼å€å¡Šæ ¼å¼
            MESSAGE+="[>>é»æ­¤é–±è®€æ–‡ç« ](${ARTICLE_URL})\n" # æ–‡ç« é€£çµ
            MESSAGE+="by ${{ github.event.head_commit.author.name }}"

            # å°‡è¨Šæ¯ç·¨ç¢¼ç‚º URL-encoded æ ¼å¼ï¼Œä¸¦ä½¿ç”¨ MarkdownV2
            # é€™è£¡å°ç‰¹æ®Šå­—å…ƒé€²è¡Œæ›´åš´æ ¼çš„ URL ç·¨ç¢¼ï¼Œä»¥ç¢ºä¿ MarkdownV2 æ¨¡å¼ä¸‹ä¸è§£æéŒ¯èª¤
            ENCODED_MESSAGE=$(echo -e "${MESSAGE}" | sed -E 's/([_*\[\]()~`>#+-=|{}!.\\])/\\\1/g' | sed 's/ /%20/g' | sed 's/\n/%0A/g' | sed 's/\*/%2A/g' | sed 's/\[/%5B/g' | sed 's/\]/%5D/g' | sed 's/(/%28/g' | sed 's/)/%29/g' | sed 's/`/%60/g' | sed 's/{/%7B/g' | sed 's/}/%7D/g' | sed 's/~/%7E/g' | sed 's/\./%2E/g')
            
            # ç™¼é€ Telegram è¨Šæ¯
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${ENCODED_MESSAGE}" \
              -d "parse_mode=MarkdownV2" # ç¢ºä¿ä½¿ç”¨ MarkdownV2

            echo "Telegram notification sent for $file_path with title: $TITLE"
          done
        env: # å°‡ç’°å¢ƒè®Šæ•¸è¨­å®šåœ¨é€™è£¡
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
